import*as t from"@tensorflow/tfjs";import{tidy as e,initializers as r,basicLSTMCell as n,stack as i,dropout as o,sum as s,tensor as u,oneHot as a,dispose as c,zeros as l,concat as h,mul as f,ones as v,metrics as m,keep as d,math as p,eye as y,train as g}from"@tensorflow/tfjs";import{load as S}from"@tensorflow-models/universal-sentence-encoder";var P=function(){function t(){}var e=t.prototype;return e.init=function(t){try{return this.actions=t,Promise.resolve()}catch(t){return Promise.reject(t)}},e.getOptimizableFeatures=function(t){return t},e.handleAction=function(t){},e.getActionMask=function(){return this.actions.map(function(){return!0})},e.resetDialog=function(){},e.load=function(t){},e.export=function(){return Promise.resolve({})},t}();function z(){return(z=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function b(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function A(t,e){for(var r=Array.from(Array(t.length+1),function(){return new Array(e.length+1).fill(0)}),n=1;n<=t.length;n+=1)r[n][0]=n;for(var i=1;i<=e.length;i+=1)r[0][i]=i;for(var o=0;o<e.length;o+=1)for(var s=0;s<t.length;s+=1)r[s+1][o+1]=Math.min(r[s][o+1]+1,r[s+1][o]+1,r[s][o]+(t[s]!==e[o]?1:0));return r[t.length][e.length]/Math.max(t.length,e.length,1)}function x(t,e){for(var r={extract:void 0,score:0},n=0;n<t.length;n+=1){var i=t.substring(n,n+e.length),o={extract:i,score:1-A(i,e)};if(1===o.score)return o;o.score>r.score&&(r=o)}return r}function j(t){for(var e=0,r=0;r<t.length;r+=1)e=(e<<5)-e+t.charCodeAt(r),e|=0;return e}function k(t,n,i){return void 0===n&&(n=!1),void 0===i&&(i="he"),e(function(){var e;switch(i){case"he":e=r.heNormal({});break;case"zeros":e=r.zeros();break;case"normal":e=r.randomNormal({});break;default:throw new Error("Expected parameter init to take value 'he', 'zeros' or 'normal' not '"+i+"'.")}var o=e.apply(t);return n&&(o=o.asScalar()),o.variable()})}var O=function(){function t(t,e,r,n){void 0===n&&(n=.2),this.lstmKernel=k([t+e,4*e]),this.lstmBias=k([4*e],!1,"zeros"),this.lstmForgetBias=k([1],!0,"zeros"),this.lstmInitH=k([1,e]),this.lstmInitC=k([1,e]),this.denseWeights=k([e,r]),this.denseBias=k([r],!1,"zeros"),this.dropout=n}var r=t.prototype;return r.initLSTM=function(t){return void 0===t&&(t=!0),{c:t?this.lstmInitC.clone():this.lstmInitC,h:t?this.lstmInitH.clone():this.lstmInitH}},r.predict=function(t,r,u,a,c){var l=this;return void 0===c&&(c=1),e(function(){var e=n(l.lstmForgetBias,l.lstmKernel,l.lstmBias,i([t]),u,r),h=e[0],f=e[1],v=o(f,l.dropout).matMul(l.denseWeights).add(l.denseBias).squeeze().div(c).softmax().mul(null!=a?a:1);return{y:v=v.div(s(v)),nc:h,nh:f}})},r.load=function(t){var r=this;e(function(){r.lstmKernel=u(t.lstmKernel).variable(),r.lstmBias=u(t.lstmBias).variable(),r.lstmForgetBias=u(t.lstmForgetBias).variable(),r.lstmInitH=u(t.lstmInitH).variable(),r.lstmInitC=u(t.lstmInitC).variable(),r.denseWeights=u(t.denseWeights).variable(),r.denseBias=u(t.denseBias).variable()})},r.export=function(){try{var t=this;return Promise.resolve(t.lstmKernel.array()).then(function(e){return Promise.resolve(t.lstmBias.array()).then(function(r){return Promise.resolve(t.lstmForgetBias.array()).then(function(n){return Promise.resolve(t.lstmInitH.array()).then(function(i){return Promise.resolve(t.lstmInitC.array()).then(function(o){return Promise.resolve(t.denseWeights.array()).then(function(s){return Promise.resolve(t.denseBias.array()).then(function(t){return{lstmKernel:e,lstmBias:r,lstmForgetBias:n,lstmInitH:i,lstmInitC:o,denseWeights:s,denseBias:t}})})})})})})})}catch(t){return Promise.reject(t)}},t}(),M={__proto__:null,fuzzyMatch:x,hashcode:j,initializeVariable:k,levenshteinDistance:A,LSTM:O},_={__proto__:null,Featurizer:P,ActionFeaturizer:function(t){function r(e){var r,n=void 0===e?{maskLUS:!0,maskPreviousAction:!0,LUSAction:"LUS"}:e,i=n.maskLUS,o=void 0===i||i,s=n.maskPreviousAction,u=void 0===s||s,a=n.LUSAction,c=void 0===a?"LUS":a;return(r=t.call(this)||this).id="Action Featurizer",r.maskLUS=o,r.maskPreviousAction=u,r.LUSAction=c,r.resetDialog(),r}b(r,t);var n=r.prototype;return n.init=function(e){try{var r=this;return Promise.resolve(t.prototype.init.call(r,e)).then(function(){r.size=e.length,r.embeddings=k([r.size,r.size])})}catch(t){return Promise.reject(t)}},n.handleQuery=function(t){try{var r=this;return Promise.resolve(e(function(){return r.userTalked=""!==t,a([r.actions.indexOf(r.previousAction)],r.actions.length)}))}catch(t){return Promise.reject(t)}},n.getOptimizableFeatures=function(t){return t.matMul(this.embeddings).squeeze()},n.handleAction=function(t){this.previousAction=t!==this.LUSAction?t:this.previousAction},n.getActionMask=function(){var e=t.prototype.getActionMask.call(this);return this.maskLUS&&this.userTalked&&(e[this.actions.indexOf(this.LUSAction)]=!1),this.maskPreviousAction&&this.actions.includes(this.previousAction)&&(e[this.actions.indexOf(this.previousAction)]=!1),e},n.resetDialog=function(){this.userTalked=!1,this.previousAction=void 0},n.load=function(t){this.embeddings=e(function(){return u(t.embeddings).variable()})},n.export=function(){try{return Promise.resolve(this.embeddings.array()).then(function(t){return{embeddings:t}})}catch(t){return Promise.reject(t)}},r}(P),BOW:function(t){function r(e){var r;return(r=t.call(this)||this).id="Bag-of-Words",r.size=e,r}return b(r,t),r.prototype.handleQuery=function(t){try{var r=this;return Promise.resolve(e(function(){var e=t.toLowerCase().split(/\W/g).map(function(t){return j(t)%r.size});return a(e,r.size).asType("float32").sum(0)}))}catch(t){return Promise.reject(t)}},r}(P),USE:function(t){function e(){var e;return(e=t.apply(this,arguments)||this).id="Universal Sentence Encoder",e.size=512,e}b(e,t);var r=e.prototype;return r.init=function(e){try{var r=this;return Promise.resolve(t.prototype.init.call(r,e)).then(function(){return Promise.resolve(S()).then(function(t){return r.encoder=t,Promise.resolve(r.encodeQuery("")).then(function(t){r.emptyEncoding=t})})})}catch(t){return Promise.reject(t)}},r.encodeQuery=function(t){try{return Promise.resolve(this.encoder.embed([t])).then(function(t){var e=t.squeeze();return c(t),e})}catch(t){return Promise.reject(t)}},r.handleQuery=function(t){try{return Promise.resolve(t?this.encodeQuery(t):this.emptyEncoding.clone())}catch(t){return Promise.reject(t)}},e}(P),WordEmbedding:function(t){function r(e,r){var n;return(n=t.call(this)||this).id="Word Embedding",n.size=2*r,n.loaderFunction=e,n}b(r,t);var n=r.prototype;return n.init=function(e){try{var r=this;return Promise.resolve(t.prototype.init.call(r,e)).then(function(){return Promise.resolve(r.loaderFunction()).then(function(t){r.vectors=JSON.parse(t)})})}catch(t){return Promise.reject(t)}},n.handleQuery=function(t){try{var r=this;return Promise.resolve(e(function(){var e=t.toLowerCase().split(/\W/g).filter(function(t){return t.length>0}),n=[];if(e.forEach(function(t){if(Object.keys(r.vectors).includes(t))n.push(u(r.vectors[t]));else{var e,i=Infinity;Object.keys(r.vectors).forEach(function(r){var n=A(r,t);n<i&&(e=r,i=n)}),i<.5&&n.push(u(r.vectors[e]))}}),0===n.length)return l([r.size]);var o=i(n);return h([o.mean(0),o.max(0)])}))}catch(t){return Promise.reject(t)}},r}(P)};const L=function(){function t(){}return t.prototype.then=function(e,r){const n=new t,i=this.s;if(i){const t=1&i?e:r;if(t){try{C(n,1,t(this.v))}catch(t){C(n,2,t)}return n}return this}return this.o=function(t){try{const i=t.v;1&t.s?C(n,1,e?e(i):i):r?C(n,1,r(i)):C(n,2,i)}catch(t){C(n,2,t)}},n},t}();function C(t,e,r){if(!t.s){if(r instanceof L){if(!r.s)return void(r.o=C.bind(null,t,e));1&e&&(e=r.s),r=r.v}if(r&&r.then)return void r.then(C.bind(null,t,e),C.bind(null,t,2));t.s=e,t.v=r;const n=t.o;n&&n(t)}}function B(t){return t instanceof L&&1&t.s}function D(t,e,r){for(var n;;){var i=t();if(B(i)&&(i=i.v),!i)return o;if(i.then){n=0;break}var o=r();if(o&&o.then){if(!B(o)){n=1;break}o=o.s}if(e){var s=e();if(s&&s.then&&!B(s)){n=2;break}}}var u=new L,a=C.bind(null,u,2);return(0===n?i.then(l):1===n?o.then(c):s.then(h)).then(void 0,a),u;function c(n){o=n;do{if(e&&(s=e())&&s.then&&!B(s))return void s.then(h).then(void 0,a);if(!(i=t())||B(i)&&!i.v)return void C(u,1,o);if(i.then)return void i.then(l).then(void 0,a);B(o=r())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,a)}function l(t){t?(o=r())&&o.then?o.then(c).then(void 0,a):c(o):C(u,1,o)}function h(){(i=t())?i.then?i.then(l).then(void 0,a):l(i):C(u,1,o)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var F={__proto__:null,HCN:function(){function r(t){var e=t.actions,r=t.featurizers,n=t.hiddenSize,i=void 0===n?32:n,o=t.optimizer,s=void 0===o?g.adam(.01):o,u=t.temperature,a=void 0===u?1:u,c=t.dropout,l=void 0===c?0:c;this.actions=e,this.featurizers=r,this.optimizer=s,this.hiddenSize=i,this.outputSize=e.length,this.lstmTemperature=a,this.lstmDropout=l}var n=r.prototype;return n.init=function(){try{var t=this;return Promise.resolve(Promise.all(t.featurizers.map(function(e){return e.init(t.actions)}))).then(function(){t.inputSize=t.featurizers.map(function(t){return t.size}).reduce(function(t,e){return t+e},1),t.lstm=new O(t.inputSize,t.hiddenSize,t.outputSize,t.lstmDropout),t.resetDialog()})}catch(t){return Promise.reject(t)}},n.resetDialog=function(){this.featurizers.forEach(function(t){return t.resetDialog()});var t=this.lstm.initLSTM();this.lstmC=t.c,this.lstmH=t.h},n.handleQuery=function(t){try{return Promise.all(this.featurizers.map(function(e){return e.handleQuery(t)}))}catch(t){return Promise.reject(t)}},n.getOptimizableFeatures=function(t){var r=this;return e(function(){var e=r.featurizers.map(function(e,r){return e.getOptimizableFeatures(t[r])});return e.push(l([1])),h(e)})},n.handleAction=function(t){this.featurizers.map(function(e){return e.handleAction(t)})},n.getActionMask=function(){var t=this;return e(function(){return t.featurizers.map(function(t){return u(t.getActionMask(),void 0,"float32")}).reduce(function(t,e){return f(t,e)},v([t.actions.length]))})},n.fitStory=function(t){try{var e=function(){var t;return r.optimizer.minimize(function(){var e=r.lstm.initLSTM(!1),u=e.c,a=e.h,c=n.map(function(t,e){var n=r.lstm.predict(r.getOptimizableFeatures(t),u,a,o[e]);return u=n.nc,a=n.nh,n.y}),l=i(s),h=i(c),f=m.categoricalCrossentropy(l,h).mean();return t={targets:d(l.argMax(1)),predictions:d(h.argMax(1)),loss:f.arraySync(),isFailing:m.categoricalAccuracy(l,h).mean().arraySync()<.999},f}),c([n,s]),t},r=this;r.resetDialog();var n=[],o=[],s=[],u=0,l=D(function(){return u<t.length},function(){return!!(u+=1)},function(){var e=t[u],i=n.push;return Promise.resolve(r.handleQuery(e.query)).then(function(t){i.call(n,t),o.push(r.getActionMask()),s.push(a(r.actions.indexOf(e.action),r.outputSize)),r.handleAction(e.action)})});return Promise.resolve(l&&l.then?l.then(e):e())}catch(t){return Promise.reject(t)}},n.train=function(r){var n=r.stories,i=r.nEpochs,o=void 0===i?12:i,s=r.onEpochEnd,u=void 0===s?void 0:s;try{var a,l=function(){return f.resetDialog(),a},f=this,v=0,m=D(function(){return v<o},function(){return!!(v+=1)},function(){function r(){var r=e(function(){return p.confusionMatrix(h(i),h(o),f.outputSize)}),n=e(function(){return r.mul(y.apply(t,r.shape)).sum(0)});a={epoch:v,failingSamples:l,accuracy:e(function(){return n.sum().div(r.sum()).arraySync()}),recall:e(function(){return n.div(r.sum(1)).mean().arraySync()}),precision:e(function(){return n.div(r.sum(0)).mean().arraySync()}),loss:s.reduce(function(t,e){return t+e})/s.length},c(i),c(o),c([n,r]),void 0!==u&&u(a)}var i=[],o=[],s=[],l=[],m=0,d=D(function(){return m<n.length},function(){return!!(m+=1)},function(){return Promise.resolve(f.fitStory(n[m])).then(function(t){i.push(t.targets),o.push(t.predictions),s.push(t.loss),t.isFailing&&l.push(m)})});return d&&d.then?d.then(r):r()});return Promise.resolve(m&&m.then?m.then(l):l())}catch(t){return Promise.reject(t)}},n.predict=function(t){try{var r=this;r.lstm.dropout=0;var n=r.getOptimizableFeatures;return Promise.resolve(r.handleQuery(t)).then(function(t){var i=n.call(r,t),o=r.getActionMask(),s=r.lstm.predict(i,r.lstmC,r.lstmH,o,r.lstmTemperature);c([r.lstmC,r.lstmH]),r.lstmC=s.nc.clone(),r.lstmH=s.nh.clone();var u=e(function(){return s.y.argMax().arraySync()}),a=e(function(){return s.y.arraySync()[u]});return c([i,o]),c(s),r.lstm.dropout=r.lstmDropout,r.handleAction(r.actions[u]),{action:r.actions[u],confidence:a}})}catch(t){return Promise.reject(t)}},n.score=function(r){try{var n=function(){var r=e(function(){return p.confusionMatrix(u(o),u(s),i.outputSize)}),n=e(function(){return r.mul(y.apply(t,r.shape)).sum(0)}),h={failingSamples:l,accuracy:e(function(){return n.sum().div(r.sum()).arraySync()}),recall:e(function(){return n.div(r.sum(1)).mean().arraySync()}),precision:e(function(){return n.div(r.sum(0)).mean().arraySync()}),averageConfidence:a.reduce(function(t,e){return t+e})/a.length};return c([n,r]),i.resetDialog(),h},i=this,o=[],s=[],a=[],l=[],h=0,f=D(function(){return h<r.length},function(){return!!(h+=1)},function(){i.resetDialog();var t=0,e=D(function(){return t<r[h].length},function(){return!!(t+=1)},function(){var e=r[h][t];return Promise.resolve(i.predict(e.query)).then(function(t){var r=t.action,n=t.confidence;o.push(i.actions.indexOf(e.action)),s.push(i.actions.indexOf(r)),a.push(n),r===e.action||l.includes(h)||l.push(h)})});if(e&&e.then)return e.then(function(){})});return Promise.resolve(f&&f.then?f.then(n):n())}catch(t){return Promise.reject(t)}},n.load=function(t){var e=JSON.parse(t);this.featurizers.forEach(function(t){t.load(e[t.id])}),this.lstm.load(e.lstm),this.resetDialog()},n.export=function(){try{var t=this;return Promise.resolve(t.lstm.export()).then(function(e){function r(){return JSON.stringify(n)}var n={lstm:e},i=0,o=D(function(){return i<t.featurizers.length},function(){return!!(i+=1)},function(){var e=t.featurizers[i];return Promise.resolve(e.export()).then(function(t){n[e.id]=t})});return o&&o.then?o.then(r):r()})}catch(t){return Promise.reject(t)}},r}()},I=function(t){function e(e,r){var n;return(n=t.call(this)||this).dependantActions=e,n.invDependantActions=r,n}b(e,t);var r=e.prototype;return r.getActionMask=function(){var t=this;return this.actions.map(function(e){var r=void 0!==t.value,n=t.dependantActions.includes(e),i=t.invDependantActions.includes(e);return!r&&(!n||i)||r&&!i})},r.resetDialog=function(){this.value=void 0},r.getValue=function(){return this.value},r.setValue=function(t){this.value=t},e}(P),w={__proto__:null,Slot:I,CategoricalSlot:function(t){function r(e){var r,n=e.categories,i=e.dependantActions,o=e.invDependantActions,s=e.threshold,u=void 0===s?.75:s;return(r=t.call(this,void 0===i?[]:i,void 0===o?[]:o)||this).categoryNames=Object.keys(n),r.categories=n,r.threshold=u,r.id="Categorical Slot #"+j(JSON.stringify(r.categoryNames)),r.size=2*r.categoryNames.length,r}b(r,t);var n=r.prototype;return n.init=function(e){try{var r=this;return Promise.resolve(t.prototype.init.call(r,e)).then(function(){r.resetDialog()})}catch(t){return Promise.reject(t)}},n.oneHotValue=function(t){var e=Object.keys(this.categories);return a(e.indexOf(t.category),e.length)},n.handleQuery=function(t){try{var r=this,n={category:void 0,extract:void 0,score:0};Object.entries(r.categories).forEach(function(e){var i=e[0],o=e[1].map(function(e){return x(t.toLowerCase(),e.toLowerCase())}).filter(function(t){return t.score>=r.threshold}).reduce(function(t,e){return t.score>e.score?t:e},{extract:void 0,score:0});o.score>n.score&&(n=z({category:i},o))});var i=e(function(){return h([r.oneHotValue(n),r.oneHotValue(r.getValue())])});return void 0!==n.category&&r.setValue(n),Promise.resolve(i)}catch(t){return Promise.reject(t)}},n.getValue=function(){return void 0===t.prototype.getValue.call(this)?{category:void 0,extract:void 0,score:0}:t.prototype.getValue.call(this)},r}(I)},E={__proto__:null,parseStories:function(t){var e=[],r=[],n=!0;return t.split("\n").forEach(function(t){var i=/^## *([^#].*)?$/gm.exec(t),o=/^> *(.*)$/gm.exec(t),s=/^- *(\w*)$/gm.exec(t);null!=i&&r.length>0?(r.push({query:"",action:"LUS"}),e.push(r),r=[]):null!=o?(r.length>0&&r.push({query:"",action:"LUS"}),r.push({query:o[1],action:void 0}),n=!1):null!=s&&n?r.push({query:"",action:s[1]}):null==s||n||(r[r.length-1].action=s[1],n=!0)}),r.length>0&&(r.push({query:"",action:"LUS"}),e.push(r)),e},trainTestSplit:function(t,e){for(var r=[],n=0;n/t.length<e;n+=1)r.push.apply(r,t.splice(Math.floor(Math.random()*t.length),1));return{train:t,test:r}}};export{_ as featurizers,F as models,w as slots,E as tools,M as utils};
//# sourceMappingURL=wisty.esm.js.map
