import{tidy as t,basicLSTMCell as e,stack as n,dropout as r,losses as i,metrics as o,train as s,randomNormal as a,zeros as u,concat as c,dispose as l,tensor as h,mul as f,ones as v,oneHot as m,moments as d}from"@tensorflow/tfjs";import{load as y}from"@tensorflow-models/universal-sentence-encoder";var g=function(){function u(t,e,n,r,i){void 0===r&&(r=s.adam()),void 0===i&&(i=.2),this.lstmKernel=u.randomVariable([t+e,4*e]),this.lstmBias=u.randomVariable([4*e]),this.lstmForgetBias=u.randomVariable([1],!0),this.lstmInitH=u.randomVariable([1,e]),this.lstmInitC=u.randomVariable([1,e]),this.denseWeights=u.randomVariable([e,n]),this.denseBias=u.randomVariable([n]),this.optimizer=r,this.dropout=i}u.randomVariable=function(e,n){return void 0===n&&(n=!1),t(function(){var t=a(e);return n&&(t=t.asScalar()),t.variable()})};var c=u.prototype;return c.initLSTM=function(){return{c:this.lstmInitC.clone(),h:this.lstmInitH.clone()}},c.predict=function(i,o,s,a){var u=this;return t(function(){var t=e(u.lstmForgetBias,u.lstmKernel,u.lstmBias,n([i]),s,o),c=t[0],l=t[1];return{y:r(l,u.dropout).matMul(u.denseWeights).add(u.denseBias).squeeze().mul(null!=a?a:1),nc:c,nh:l}})},c.fitSequence=function(t,e,r){var s,a,u=this;return this.optimizer.minimize(function(){var c=u.lstmInitC,l=u.lstmInitH,h=t.unstack(),f=null==r?void 0:r.unstack(),v=n(h.map(function(t,e){var n=u.predict(t,c,l,null==f?void 0:f[e]);return c=n.nc,l=n.nh,n.y})),m=i.softmaxCrossEntropy(e,v);return s=m.arraySync(),a=o.categoricalAccuracy(e,v).mean().arraySync(),m}),{loss:s,accuracy:a}},c.setWeights=function(t){var e=this;Object.entries(t).forEach(function(t){var n=t[1];switch(t[0]){case"lstmKernel":e.lstmKernel=n;break;case"lstmBias":e.lstmBias=n;break;case"lstmForgetBias":e.lstmForgetBias=n;break;case"lstmInitH":e.lstmInitH=n;break;case"lstmInitC":e.lstmInitC=n;break;case"denseWeights":e.denseWeights=n;break;case"denseBias":e.denseBias=n}})},c.getWeights=function(){return{lstmKernel:this.lstmKernel.clone(),lstmBias:this.lstmBias.clone(),lstmForgetBias:this.lstmForgetBias.clone(),lstmInitH:this.lstmInitH.clone(),lstmInitC:this.lstmInitC.clone(),denseWeights:this.denseWeights.clone(),denseBias:this.denseBias.clone()}},u}();function p(){return(p=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}const b=function(){function t(){}return t.prototype.then=function(e,n){const r=new t,i=this.s;if(i){const t=1&i?e:n;if(t){try{S(r,1,t(this.v))}catch(t){S(r,2,t)}return r}return this}return this.o=function(t){try{const i=t.v;1&t.s?S(r,1,e?e(i):i):n?S(r,1,n(i)):S(r,2,i)}catch(t){S(r,2,t)}},r},t}();function S(t,e,n){if(!t.s){if(n instanceof b){if(!n.s)return void(n.o=S.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(S.bind(null,t,e),S.bind(null,t,2));t.s=e,t.v=n;const r=t.o;r&&r(t)}}function z(t){return t instanceof b&&1&t.s}function P(t,e,n){for(var r;;){var i=t();if(z(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=n();if(o&&o.then){if(!z(o)){r=1;break}o=o.s}if(e){var s=e();if(s&&s.then&&!z(s)){r=2;break}}}var a=new b,u=S.bind(null,a,2);return(0===r?i.then(l):1===r?o.then(c):s.then(h)).then(void 0,u),a;function c(r){o=r;do{if(e&&(s=e())&&s.then&&!z(s))return void s.then(h).then(void 0,u);if(!(i=t())||z(i)&&!i.v)return void S(a,1,o);if(i.then)return void i.then(l).then(void 0,u);z(o=n())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,u)}function l(t){t?(o=n())&&o.then?o.then(c).then(void 0,u):c(o):S(a,1,o)}function h(){(i=t())?i.then?i.then(l).then(void 0,u):l(i):S(a,1,o)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var k=function(){function e(t,e,n,r,i){void 0===n&&(n=128),void 0===r&&(r=s.adam(.01)),void 0===i&&(i=.2),this.actions=t,this.featurizers=e,this.inputSize=e.map(function(t){return t.size}).reduce(function(t,e){return t+e},1),this.outputSize=t.length,this.lstm=new g(this.inputSize,n,this.outputSize,r,i),this.lstmDropout=i,this.resetDialog()}var r=e.prototype;return r.resetDialog=function(){this.featurizers.forEach(function(t){return t.resetDialog()});var t=this.lstm.initLSTM();this.lstmC=t.c,this.lstmH=t.h},r.featurize=function(t){try{return Promise.resolve(Promise.all(this.featurizers.map(function(e){return e.handleQuery(t)}))).then(function(t){t.push(u([1]));var e=c(t);return l(t),e})}catch(t){return Promise.reject(t)}},r.getMasks=function(){var e=this;return t(function(){return e.featurizers.filter(function(t){return void 0!==t.getActionMask}).map(function(t){return h(t.getActionMask(e.actions),void 0,"float32")}).reduce(function(t,e){return f(t,e)},v([e.actions.length]))})},r.fitStory=function(e,r){try{var i=function(){var e=p({epoch:r},t(function(){return o.lstm.fitSequence(n(s),n(u),n(a))}));return l([s,u]),e},o=this;o.resetDialog();var s=[],a=[],u=[],c=0,h=P(function(){return c<e.length},function(){return!!(c+=1)},function(){var t=e[c],n=s.push;return Promise.resolve(o.featurize(t.query)).then(function(e){n.call(s,e),a.push(o.getMasks()),u.push(m(o.actions.indexOf(t.action),o.outputSize))})});return Promise.resolve(h&&h.then?h.then(i):i())}catch(t){return Promise.reject(t)}},r.train=function(t,e,n){void 0===e&&(e=12);try{var r=function(){return i.resetDialog(),o},i=this,o=[],s=0,a=P(function(){return s<e},function(){return!!(s+=1)},function(){var e=[];return t.forEach(function(t){e.push(i.fitStory(t,s))}),Promise.resolve(Promise.all(e)).then(function(t){e=t,void 0!==n&&n(e),o.push.apply(o,e)})});return Promise.resolve(a&&a.then?a.then(r):r())}catch(t){return Promise.reject(t)}},r.predict=function(e,r,i){void 0===r&&(r=10),void 0===i&&(i=1);try{var o=this;return o.lstm.dropout=1===r?0:o.lstmDropout,Promise.resolve(o.featurize(e)).then(function(e){for(var s,a=o.getMasks(),u=[],c=0;c<r;c+=1)l(s),s=o.lstm.predict(e,o.lstmC,o.lstmH,a),u.push(t(function(){return s.y.div(i).softmax()}));l([o.lstmC,o.lstmH]),o.lstmC=s.nc.clone(),o.lstmH=s.nh.clone();var h=t(function(){return d(n(u),0)}),f=h.mean,v=h.variance,m=t(function(){return f.argMax().arraySync()}),y=1-t(function(){return v.sqrt().arraySync()[m]});return l([e,a,f,v]),l(s),l(u),{action:o.actions[m],confidence:y}})}catch(t){return Promise.reject(t)}},r.load=function(e){var n=this;t(function(){var t=JSON.parse(e);Object.entries(t).forEach(function(e){t[e[0]]=h(e[1]).variable()}),n.lstm.setWeights(t)})},r.export=function(){var e=this;return t(function(){var t={};return Object.entries(e.lstm.getWeights()).forEach(function(e){t[e[0]]=e[1].arraySync()}),JSON.stringify(t)})},e}(),j=function(){function t(){this.size=512}var e=t.prototype;return e.init=function(){try{var t=this;return Promise.resolve(y()).then(function(e){return t.encoder=e,Promise.resolve(t.encodeQuery("")).then(function(e){t.emptyEncoding=e})})}catch(t){return Promise.reject(t)}},e.encodeQuery=function(t){try{return Promise.resolve(this.encoder.embed([t])).then(function(t){var e=t.squeeze();return l(t),e})}catch(t){return Promise.reject(t)}},e.handleQuery=function(t){try{return Promise.resolve(t?this.encodeQuery(t):this.emptyEncoding.clone())}catch(t){return Promise.reject(t)}},e.resetDialog=function(){},t}();function B(t){for(var e=0,n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}var x=function(){function e(t){this.size=t}var n=e.prototype;return n.handleQuery=function(e){try{var n=this;return Promise.resolve(t(function(){var t=e.split(" ").map(function(t){return B(t)%n.size});return m(t,n.size).asType("float32").sum(0)}))}catch(t){return Promise.reject(t)}},n.resetDialog=function(){},e}();function I(t,e){for(var n=Array.from(Array(t.length+1),function(){return new Array(e.length+1).fill(0)}),r=1;r<=t.length;r+=1)n[r][0]=r;for(var i=1;i<=e.length;i+=1)n[0][i]=i;for(var o=0;o<e.length;o+=1)for(var s=0;s<t.length;s+=1)n[s+1][o+1]=Math.min(n[s][o+1]+1,n[s+1][o]+1,n[s][o]+(t[s]!==e[o]?1:0));return n[t.length][e.length]/Math.max(t.length,e.length,1)}function C(t,e){for(var n={extract:void 0,score:0},r=0;r<t.length;r+=1){var i=t.substring(r,r+e.length),o={extract:i,score:1-I(i,e)};if(1===o.score)return o;o.score>n.score&&(n=o)}return n}var D=function(){function e(t,e,n,r){void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===r&&(r=.75),this.categoryNames=Object.keys(t),this.categories=t,this.dependantActions=e,this.inverselyDependantActions=n,this.threshold=r,this.size=2*this.categoryNames.length,this.resetDialog()}var n=e.prototype;return n.featurizeValue=function(t){var e=Object.keys(this.categories);return m(e.indexOf(t.category),e.length)},n.handleQuery=function(e){try{var n=this,r={category:void 0,extract:void 0,score:0};Object.entries(n.categories).forEach(function(t){var i=t[0],o=t[1].map(function(t){return C(e.toLowerCase(),t.toLowerCase())}).filter(function(t){return t.score>=n.threshold}).reduce(function(t,e){return t.score>e.score?t:e},{extract:void 0,score:0});o.score>r.score&&(r=p({category:i},o))});var i=t(function(){return c([n.featurizeValue(r),n.featurizeValue(n.value)])});return void 0!==r.category&&(n.value=r),Promise.resolve(i)}catch(t){return Promise.reject(t)}},n.getActionMask=function(t){var e=this;return t.map(function(t){var n=void 0===e.value.extract,r=e.dependantActions.includes(t),i=e.inverselyDependantActions.includes(t);return n&&(i||!r)||!n&&!i})},n.resetDialog=function(){this.value={category:void 0,extract:void 0,score:0}},n.getValue=function(){return this.value},e}();function O(t){var e=[],n=[],r=!0;return t.split("\n").forEach(function(t){var i=/^## *([^#].*)?$/gm.exec(t),o=/^> *(.*)$/gm.exec(t),s=/^- *(\w*)$/gm.exec(t);null!=i&&n.length>0?(n.push({query:"",action:"LUS"}),e.push(n),n=[]):null!=o?(n.length>0&&n.push({query:"",action:"LUS"}),n.push({query:o[1],action:void 0}),r=!1):null!=s&&r?n.push({query:"",action:s[1]}):null==s||r||(n[n.length-1].action=s[1],r=!0)}),n.length>0&&(n.push({query:"",action:"LUS"}),e.push(n)),e}export{x as BOW,D as CategoricalSlot,k as HCN,g as LSTM,j as USE,C as fuzzyMatch,B as hashcode,O as parseStories};
//# sourceMappingURL=wisty.esm.js.map
