var t=require("@tensorflow/tfjs"),e=require("@tensorflow-models/universal-sentence-encoder"),r=function(){function e(t,r,n,i){void 0===i&&(i=.2),this.lstmKernel=e.randomVariable([t+r,4*r]),this.lstmBias=e.randomVariable([4*r]),this.lstmForgetBias=e.randomVariable([1],!0),this.lstmInitH=e.randomVariable([1,r]),this.lstmInitC=e.randomVariable([1,r]),this.denseWeights=e.randomVariable([r,n]),this.denseBias=e.randomVariable([n]),this.dropout=i}e.randomVariable=function(e,r){return void 0===r&&(r=!1),t.tidy(function(){var n=t.randomNormal(e);return r&&(n=n.asScalar()),n.variable()})};var r=e.prototype;return r.initLSTM=function(t){return void 0===t&&(t=!0),{c:t?this.lstmInitC.clone():this.lstmInitC,h:t?this.lstmInitH.clone():this.lstmInitH}},r.predict=function(e,r,n,i,o){var s=this;return void 0===o&&(o=1),t.tidy(function(){var u=t.basicLSTMCell(s.lstmForgetBias,s.lstmKernel,s.lstmBias,t.stack([e]),n,r),a=u[0],c=u[1],l=t.dropout(c,s.dropout).matMul(s.denseWeights).add(s.denseBias).squeeze().div(o).softmax().mul(null!=i?i:1);return{y:l=l.div(t.sum(l)),nc:a,nh:c}})},r.load=function(e){var r=this;t.tidy(function(){r.lstmKernel=t.tensor(e.lstmKernel).variable(),r.lstmBias=t.tensor(e.lstmBias).variable(),r.lstmForgetBias=t.tensor(e.lstmForgetBias).variable(),r.lstmInitH=t.tensor(e.lstmInitH).variable(),r.lstmInitC=t.tensor(e.lstmInitC).variable(),r.denseWeights=t.tensor(e.denseWeights).variable(),r.denseBias=t.tensor(e.denseBias).variable()})},r.export=function(){try{var t=this;return Promise.resolve(t.lstmKernel.array()).then(function(e){return Promise.resolve(t.lstmBias.array()).then(function(r){return Promise.resolve(t.lstmForgetBias.array()).then(function(n){return Promise.resolve(t.lstmInitH.array()).then(function(i){return Promise.resolve(t.lstmInitC.array()).then(function(o){return Promise.resolve(t.denseWeights.array()).then(function(s){return Promise.resolve(t.denseBias.array()).then(function(t){return{lstmKernel:e,lstmBias:r,lstmForgetBias:n,lstmInitH:i,lstmInitC:o,denseWeights:s,denseBias:t}})})})})})})})}catch(t){return Promise.reject(t)}},e}();const n=function(){function t(){}return t.prototype.then=function(e,r){const n=new t,o=this.s;if(o){const t=1&o?e:r;if(t){try{i(n,1,t(this.v))}catch(t){i(n,2,t)}return n}return this}return this.o=function(t){try{const o=t.v;1&t.s?i(n,1,e?e(o):o):r?i(n,1,r(o)):i(n,2,o)}catch(t){i(n,2,t)}},n},t}();function i(t,e,r){if(!t.s){if(r instanceof n){if(!r.s)return void(r.o=i.bind(null,t,e));1&e&&(e=r.s),r=r.v}if(r&&r.then)return void r.then(i.bind(null,t,e),i.bind(null,t,2));t.s=e,t.v=r;const o=t.o;o&&o(t)}}function o(t){return t instanceof n&&1&t.s}function s(t,e,r){for(var s;;){var u=t();if(o(u)&&(u=u.v),!u)return a;if(u.then){s=0;break}var a=r();if(a&&a.then){if(!o(a)){s=1;break}a=a.s}if(e){var c=e();if(c&&c.then&&!o(c)){s=2;break}}}var l=new n,h=i.bind(null,l,2);return(0===s?u.then(d):1===s?a.then(f):c.then(m)).then(void 0,h),l;function f(n){a=n;do{if(e&&(c=e())&&c.then&&!o(c))return void c.then(m).then(void 0,h);if(!(u=t())||o(u)&&!u.v)return void i(l,1,a);if(u.then)return void u.then(d).then(void 0,h);o(a=r())&&(a=a.v)}while(!a||!a.then);a.then(f).then(void 0,h)}function d(t){t?(a=r())&&a.then?a.then(f).then(void 0,h):f(a):i(l,1,a)}function m(){(u=t())?u.then?u.then(d).then(void 0,h):d(u):i(l,1,a)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var u=function(){function e(e,r,n,i,o){void 0===n&&(n=128),void 0===i&&(i=t.train.adam(.01)),void 0===o&&(o=.2),this.actions=e,this.featurizers=r,this.optimizer=i,this.hiddenSize=n,this.outputSize=e.length,this.lstmDropout=o}var n=e.prototype;return n.init=function(){try{var t=this;return Promise.resolve(Promise.all(t.featurizers.map(function(e){return e.init(t.actions)}))).then(function(){t.inputSize=t.featurizers.map(function(t){return t.size}).reduce(function(t,e){return t+e},1),t.lstm=new r(t.inputSize,t.hiddenSize,t.outputSize,t.lstmDropout),t.resetDialog()})}catch(t){return Promise.reject(t)}},n.resetDialog=function(){this.featurizers.forEach(function(t){return t.resetDialog()});var t=this.lstm.initLSTM();this.lstmC=t.c,this.lstmH=t.h},n.handleQuery=function(t){try{return Promise.all(this.featurizers.map(function(e){return e.handleQuery(t)}))}catch(t){return Promise.reject(t)}},n.getOptimizableFeatures=function(e){var r=this;return t.tidy(function(){var n=r.featurizers.map(function(t,r){return t.getOptimizableFeatures(e[r])});return n.push(t.zeros([1])),t.concat(n)})},n.handleAction=function(t){this.featurizers.map(function(e){return e.handleAction(t)})},n.getActionMask=function(){var e=this;return t.tidy(function(){return e.featurizers.map(function(e){return t.tensor(e.getActionMask(),void 0,"float32")}).reduce(function(e,r){return t.mul(e,r)},t.ones([e.actions.length]))})},n.fitStory=function(e){try{var r=function(){var e;return n.optimizer.minimize(function(){var r=n.lstm.initLSTM(!1),s=r.c,a=r.h,c=i.map(function(t,e){var r=n.lstm.predict(n.getOptimizableFeatures(t),s,a,o[e]);return s=r.nc,a=r.nh,r.y}),l=t.stack(u),h=t.stack(c),f=t.metrics.categoricalCrossentropy(l,h).mean();return e={targets:t.keep(l.argMax(1)),predictions:t.keep(h.argMax(1)),loss:f.arraySync(),isFailing:t.metrics.categoricalAccuracy(l,h).mean().arraySync()<.999},f}),t.dispose([i,u]),e},n=this;n.resetDialog();var i=[],o=[],u=[],a=0,c=s(function(){return a<e.length},function(){return!!(a+=1)},function(){var r=e[a],s=i.push;return Promise.resolve(n.handleQuery(r.query)).then(function(e){s.call(i,e),o.push(n.getActionMask()),u.push(t.oneHot(n.actions.indexOf(r.action),n.outputSize)),n.handleAction(r.action)})});return Promise.resolve(c&&c.then?c.then(r):r())}catch(t){return Promise.reject(t)}},n.train=function(e,r,n){void 0===r&&(r=12);try{var i,o=function(){return u.resetDialog(),i},u=this,a=0,c=s(function(){return a<r},function(){return!!(a+=1)},function(){function r(){var e=t.tidy(function(){return t.math.confusionMatrix(t.concat(o),t.concat(c),u.outputSize)}),r=t.tidy(function(){return e.mul(t.eye.apply(t,e.shape)).sum(0)});i={epoch:a,failingSamples:h,accuracy:t.tidy(function(){return r.sum().div(e.sum()).arraySync()}),recall:t.tidy(function(){return r.div(e.sum(1)).mean().arraySync()}),precision:t.tidy(function(){return r.div(e.sum(0)).mean().arraySync()}),loss:l.reduce(function(t,e){return t+e})/l.length},t.dispose(o),t.dispose(c),t.dispose([r,e]),void 0!==n&&n(i)}var o=[],c=[],l=[],h=[],f=0,d=s(function(){return f<e.length},function(){return!!(f+=1)},function(){return Promise.resolve(u.fitStory(e[f])).then(function(t){o.push(t.targets),c.push(t.predictions),l.push(t.loss),t.isFailing&&h.push(f)})});return d&&d.then?d.then(r):r()});return Promise.resolve(c&&c.then?c.then(o):o())}catch(t){return Promise.reject(t)}},n.predict=function(e,r,n){void 0===r&&(r=1),void 0===n&&(n=1);try{var i=this;i.lstm.dropout=1===r?0:i.lstmDropout;var o=i.getOptimizableFeatures;return Promise.resolve(i.handleQuery(e)).then(function(e){for(var s,u=o.call(i,e),a=i.getActionMask(),c=[],l=0;l<r;l+=1)t.dispose(s),s=i.lstm.predict(u,i.lstmC,i.lstmH,a,n),c.push(s.y);t.dispose([i.lstmC,i.lstmH]),i.lstmC=s.nc.clone(),i.lstmH=s.nh.clone();var h=t.tidy(function(){return t.moments(t.stack(c),0)}),f=h.mean,d=h.variance,m=t.tidy(function(){return f.argMax().arraySync()}),v=t.tidy(function(){return f.sub(d.sqrt()).arraySync()[m]});return t.dispose([u,a,f,d]),t.dispose(s),t.dispose(c),i.handleAction(i.actions[m]),{action:i.actions[m],confidence:v}})}catch(t){return Promise.reject(t)}},n.score=function(e,r,n){void 0===r&&(r=1),void 0===n&&(n=1);try{var i=function(){var e=t.tidy(function(){return t.math.confusionMatrix(t.tensor(u),t.tensor(a),o.outputSize)}),r=t.tidy(function(){return e.mul(t.eye.apply(t,e.shape)).sum(0)}),n={failingSamples:l,accuracy:t.tidy(function(){return r.sum().div(e.sum()).arraySync()}),recall:t.tidy(function(){return r.div(e.sum(1)).mean().arraySync()}),precision:t.tidy(function(){return r.div(e.sum(0)).mean().arraySync()}),averageConfidence:c.reduce(function(t,e){return t+e})/c.length};return t.dispose([r,e]),o.resetDialog(),n},o=this,u=[],a=[],c=[],l=[],h=0,f=s(function(){return h<e.length},function(){return!!(h+=1)},function(){o.resetDialog();var t=0,i=s(function(){return t<e[h].length},function(){return!!(t+=1)},function(){var i=e[h][t];return Promise.resolve(o.predict(i.query,r,n)).then(function(t){var e=t.action,r=t.confidence;u.push(o.actions.indexOf(i.action)),a.push(o.actions.indexOf(e)),c.push(r),e===i.action||l.includes(h)||l.push(h)})});if(i&&i.then)return i.then(function(){})});return Promise.resolve(f&&f.then?f.then(i):i())}catch(t){return Promise.reject(t)}},n.load=function(t){var e=JSON.parse(t);this.featurizers.forEach(function(t){t.load(e[t.id])}),this.lstm.load(e.lstm),this.resetDialog()},n.export=function(){try{var t=this;return Promise.resolve(t.lstm.export()).then(function(e){function r(){return JSON.stringify(n)}var n={lstm:e},i=0,o=s(function(){return i<t.featurizers.length},function(){return!!(i+=1)},function(){var e=t.featurizers[i];return Promise.resolve(e.export()).then(function(t){n[e.id]=t})});return o&&o.then?o.then(r):r()})}catch(t){return Promise.reject(t)}},e}();function a(){return(a=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t}).apply(this,arguments)}function c(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var l=function(){function t(){}var e=t.prototype;return e.init=function(t){try{return this.actions=t,Promise.resolve()}catch(t){return Promise.reject(t)}},e.getOptimizableFeatures=function(t){return t},e.handleAction=function(t){},e.getActionMask=function(){return this.actions.map(function(){return!0})},e.resetDialog=function(){},e.load=function(t){},e.export=function(){return Promise.resolve({})},t}(),h=function(r){function n(){var t;return(t=r.apply(this,arguments)||this).id="Universal Sentence Encoder",t.size=512,t}c(n,r);var i=n.prototype;return i.init=function(t){try{var n=this;return Promise.resolve(r.prototype.init.call(n,t)).then(function(){return Promise.resolve(e.load()).then(function(t){return n.encoder=t,Promise.resolve(n.encodeQuery("")).then(function(t){n.emptyEncoding=t})})})}catch(t){return Promise.reject(t)}},i.encodeQuery=function(e){try{return Promise.resolve(this.encoder.embed([e])).then(function(e){var r=e.squeeze();return t.dispose(e),r})}catch(t){return Promise.reject(t)}},i.handleQuery=function(t){try{return Promise.resolve(t?this.encodeQuery(t):this.emptyEncoding.clone())}catch(t){return Promise.reject(t)}},n}(l);function f(t){for(var e=0,r=0;r<t.length;r+=1)e=(e<<5)-e+t.charCodeAt(r),e|=0;return e}var d=function(e){function r(t){var r;return(r=e.call(this)||this).id="Bag-of-Words",r.size=t,r}return c(r,e),r.prototype.handleQuery=function(e){try{var r=this;return Promise.resolve(t.tidy(function(){var n=e.toLowerCase().split(/\W/g).map(function(t){return f(t)%r.size});return t.oneHot(n,r.size).asType("float32").sum(0)}))}catch(t){return Promise.reject(t)}},r}(l);function m(t,e){for(var r=Array.from(Array(t.length+1),function(){return new Array(e.length+1).fill(0)}),n=1;n<=t.length;n+=1)r[n][0]=n;for(var i=1;i<=e.length;i+=1)r[0][i]=i;for(var o=0;o<e.length;o+=1)for(var s=0;s<t.length;s+=1)r[s+1][o+1]=Math.min(r[s][o+1]+1,r[s+1][o]+1,r[s][o]+(t[s]!==e[o]?1:0));return r[t.length][e.length]/Math.max(t.length,e.length,1)}var v=function(e){function r(t,r){var n;return(n=e.call(this)||this).id="Word Embedding",n.size=2*r,n.loaderFunction=t,n}c(r,e);var n=r.prototype;return n.init=function(t){try{var r=this;return Promise.resolve(e.prototype.init.call(r,t)).then(function(){return Promise.resolve(r.loaderFunction()).then(function(t){r.vectors=JSON.parse(t)})})}catch(t){return Promise.reject(t)}},n.handleQuery=function(e){try{var r=this;return Promise.resolve(t.tidy(function(){var n=e.toLowerCase().split(/\W/g).filter(function(t){return t.length>0}),i=[];if(n.forEach(function(e){if(Object.keys(r.vectors).includes(e))i.push(t.tensor(r.vectors[e]));else{var n,o=Infinity;Object.keys(r.vectors).forEach(function(t){var r=m(t,e);r<o&&(n=t,o=r)}),o<.5&&i.push(t.tensor(r.vectors[n]))}}),0===i.length)return t.zeros([r.size]);var o=t.stack(i);return t.concat([o.mean(0),o.max(0)])}))}catch(t){return Promise.reject(t)}},r}(l);function p(t,e){for(var r={extract:void 0,score:0},n=0;n<t.length;n+=1){var i=t.substring(n,n+e.length),o={extract:i,score:1-m(i,e)};if(1===o.score)return o;o.score>r.score&&(r=o)}return r}var y=function(e){function r(t,r,n,i){var o;return void 0===r&&(r=[]),void 0===n&&(n=[]),void 0===i&&(i=.75),(o=e.call(this)||this).categoryNames=Object.keys(t),o.categories=t,o.id="Categorical Slot ("+f(JSON.stringify(o.categoryNames))+")",o.dependantActions=r,o.inverselyDependantActions=n,o.threshold=i,o.size=2*o.categoryNames.length,o}c(r,e);var n=r.prototype;return n.init=function(t){try{var r=this;return Promise.resolve(e.prototype.init.call(r,t)).then(function(){r.resetDialog()})}catch(t){return Promise.reject(t)}},n.featurizeValue=function(e){var r=Object.keys(this.categories);return t.oneHot(r.indexOf(e.category),r.length)},n.handleQuery=function(e){try{var r=this,n={category:void 0,extract:void 0,score:0};Object.entries(r.categories).forEach(function(t){var i=t[0],o=t[1].map(function(t){return p(e.toLowerCase(),t.toLowerCase())}).filter(function(t){return t.score>=r.threshold}).reduce(function(t,e){return t.score>e.score?t:e},{extract:void 0,score:0});o.score>n.score&&(n=a({category:i},o))});var i=t.tidy(function(){return t.concat([r.featurizeValue(n),r.featurizeValue(r.value)])});return void 0!==n.category&&(r.value=n),Promise.resolve(i)}catch(t){return Promise.reject(t)}},n.getActionMask=function(){var t=this;return this.actions.map(function(e){var r=void 0===t.value.extract,n=t.dependantActions.includes(e),i=t.inverselyDependantActions.includes(e);return r&&(i||!n)||!r&&!i})},n.resetDialog=function(){this.value={category:void 0,extract:void 0,score:0}},n.getValue=function(){return this.value},r}(l);exports.ActionFeaturizer=function(e){function r(t,r,n){var i;return void 0===t&&(t=!0),void 0===r&&(r=!0),void 0===n&&(n="LUS"),(i=e.call(this)||this).id="Action Featurizer",i.maskLUS=t,i.maskPreviousAction=r,i.LUSAction=n,i.resetDialog(),i}c(r,e);var n=r.prototype;return n.init=function(r){try{var n=this;return Promise.resolve(e.prototype.init.call(n,r)).then(function(){n.size=r.length,n.embeddings=t.tidy(function(){return t.randomNormal([n.size,n.size]).variable()})})}catch(t){return Promise.reject(t)}},n.handleQuery=function(e){try{var r=this;return Promise.resolve(t.tidy(function(){return r.userTalked=""!==e,t.oneHot([r.actions.indexOf(r.previousAction)],r.actions.length)}))}catch(t){return Promise.reject(t)}},n.getOptimizableFeatures=function(t){return t.matMul(this.embeddings).squeeze()},n.handleAction=function(t){this.previousAction=t!==this.LUSAction?t:this.previousAction},n.getActionMask=function(){var t=e.prototype.getActionMask.call(this);return this.maskLUS&&this.userTalked&&(t[this.actions.indexOf(this.LUSAction)]=!1),this.maskPreviousAction&&this.actions.includes(this.previousAction)&&(t[this.actions.indexOf(this.previousAction)]=!1),t},n.resetDialog=function(){this.userTalked=!1,this.previousAction=void 0},n.load=function(e){this.embeddings=t.tidy(function(){return t.tensor(e.embeddings).variable()})},n.export=function(){try{return Promise.resolve(this.embeddings.array()).then(function(t){return{embeddings:t}})}catch(t){return Promise.reject(t)}},r}(l),exports.BOW=d,exports.CategoricalSlot=y,exports.Featurizer=l,exports.HCN=u,exports.LSTM=r,exports.USE=h,exports.WordEmbedding=v,exports.fuzzyMatch=p,exports.hashcode=f,exports.parseStories=function(t){var e=[],r=[],n=!0;return t.split("\n").forEach(function(t){var i=/^## *([^#].*)?$/gm.exec(t),o=/^> *(.*)$/gm.exec(t),s=/^- *(\w*)$/gm.exec(t);null!=i&&r.length>0?(r.push({query:"",action:"LUS"}),e.push(r),r=[]):null!=o?(r.length>0&&r.push({query:"",action:"LUS"}),r.push({query:o[1],action:void 0}),n=!1):null!=s&&n?r.push({query:"",action:s[1]}):null==s||n||(r[r.length-1].action=s[1],n=!0)}),r.length>0&&(r.push({query:"",action:"LUS"}),e.push(r)),e};
//# sourceMappingURL=wisty.js.map
