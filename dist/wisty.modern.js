import{zeros as t,tidy as e,initializers as s,basicLSTMCell as i,stack as r,dropout as n,sum as a,tensor as o,oneHot as c,dispose as h,concat as l,train as u,mul as d,ones as m,metrics as g,keep as p,math as y,eye as f,tensor1d as v}from"@tensorflow/tfjs";import{load as z}from"@tensorflow-models/universal-sentence-encoder";class S{constructor(){this.size=1}async init(t){this.actions=t}async handleQuery(t){}getOptimizableFeatures(e){return void 0===e?t([1]):e}handleAction(t){}getActionMask(){return this.actions.map(()=>!0)}resetDialog(){}load(t){}async export(){return{}}}function A(t,e){const s=Array.from(Array(t.length+1),()=>new Array(e.length+1).fill(0));for(let e=1;e<=t.length;e+=1)s[e][0]=e;for(let t=1;t<=e.length;t+=1)s[0][t]=t;for(let i=0;i<e.length;i+=1)for(let r=0;r<t.length;r+=1)s[r+1][i+1]=Math.min(s[r][i+1]+1,s[r+1][i]+1,s[r][i]+(t[r]!==e[i]?1:0));return s[t.length][e.length]/Math.max(t.length,e.length,1)}function x(t,e){let s={extract:void 0,score:0};for(let i=0;i<t.length;i+=1){const r=t.substring(i,i+e.length),n={extract:r,score:1-A(r,e)};if(1===n.score)return n;n.score>s.score&&(s=n)}return s}function w(t){let e=0;for(let s=0;s<t.length;s+=1)e=(e<<5)-e+t.charCodeAt(s),e|=0;return e}function b(t,i=!1,r="he"){return e(()=>{let e;switch(r){case"he":e=s.heNormal({});break;case"zeros":e=s.zeros();break;case"normal":e=s.randomNormal({});break;default:throw new Error(`Expected parameter init to take value 'he', 'zeros' or 'normal' not '${r}'.`)}let n=e.apply(t);return i&&(n=n.asScalar()),n.variable()})}class k{constructor(t,e,s,i=.2){this.lstmKernel=b([t+e,4*e]),this.lstmBias=b([4*e],!1,"zeros"),this.lstmForgetBias=b([1],!0,"zeros"),this.lstmInitH=b([1,e]),this.lstmInitC=b([1,e]),this.denseWeights=b([e,s]),this.denseBias=b([s],!1,"zeros"),this.dropout=i}initLSTM(t=!0){return{c:t?this.lstmInitC.clone():this.lstmInitC,h:t?this.lstmInitH.clone():this.lstmInitH}}predict(t,s,o,c,h=1){return e(()=>{const[e,l]=i(this.lstmForgetBias,this.lstmKernel,this.lstmBias,r([t]),o,s);let u=n(l,this.dropout).matMul(this.denseWeights).add(this.denseBias).squeeze().div(h).softmax().mul(c??1);return u=u.div(a(u)),{y:u,nc:e,nh:l}})}load(t){e(()=>{this.lstmKernel=o(t.lstmKernel).variable(),this.lstmBias=o(t.lstmBias).variable(),this.lstmForgetBias=o(t.lstmForgetBias).variable(),this.lstmInitH=o(t.lstmInitH).variable(),this.lstmInitC=o(t.lstmInitC).variable(),this.denseWeights=o(t.denseWeights).variable(),this.denseBias=o(t.denseBias).variable()})}async export(){return{lstmKernel:await this.lstmKernel.array(),lstmBias:await this.lstmBias.array(),lstmForgetBias:await this.lstmForgetBias.array(),lstmInitH:await this.lstmInitH.array(),lstmInitC:await this.lstmInitC.array(),denseWeights:await this.denseWeights.array(),denseBias:await this.denseBias.array()}}}var L={__proto__:null,fuzzyMatch:x,hashcode:w,initializeVariable:b,levenshteinDistance:A,LSTM:k},D={__proto__:null,Featurizer:S,ActionFeaturizer:class extends S{constructor({maskLUS:t=!0,maskPreviousAction:e=!0,LUSAction:s="LUS"}={maskLUS:!0,maskPreviousAction:!0,LUSAction:"LUS"}){super(),this.id="Action Featurizer",this.maskLUS=t,this.maskPreviousAction=e,this.LUSAction=s,this.resetDialog()}async init(t){await super.init(t),this.size=t.length,this.embeddings=b([this.size,this.size])}async handleQuery(t){return e(()=>(this.userTalked=""!==t,c([this.actions.indexOf(this.previousAction)],this.actions.length)))}getOptimizableFeatures(t){return t.matMul(this.embeddings).squeeze()}handleAction(t){this.previousAction=t!==this.LUSAction?t:this.previousAction}getActionMask(){const t=super.getActionMask();return this.maskLUS&&this.userTalked&&(t[this.actions.indexOf(this.LUSAction)]=!1),this.maskPreviousAction&&this.actions.includes(this.previousAction)&&(t[this.actions.indexOf(this.previousAction)]=!1),t}resetDialog(){this.userTalked=!1,this.previousAction=void 0}load(t){this.embeddings=e(()=>o(t.embeddings).variable())}async export(){return{embeddings:await this.embeddings.array()}}},BOW:class extends S{constructor(t){super(),this.id="Bag-of-Words",this.size=t}async handleQuery(t){return e(()=>{const e=t.toLowerCase().split(/\W/g).map(t=>w(t)%this.size);return c(e,this.size).asType("float32").sum(0)})}},USE:class extends S{constructor(){super(...arguments),this.id="Universal Sentence Encoder",this.size=512}async init(t){await super.init(t),this.encoder=await z(),this.emptyEncoding=await this.encodeQuery("")}async encodeQuery(t){const e=await this.encoder.embed([t]),s=e.squeeze();return h(e),s}async handleQuery(t){return t?this.encodeQuery(t):this.emptyEncoding.clone()}},WordEmbedding:class extends S{constructor(t){super(),this.id="Word Embedding",this.size=2*t.size,this.vectors=t}async init(t){await super.init(t),this.vectors.isLoaded()||await this.vectors.load()}async handleQuery(s){return e(()=>{const e=s.toLowerCase().split(/\W/g).filter(t=>t.length>0),i=[];if(e.forEach(t=>i.push(this.vectors.get(t))),0===i.length)return t([this.size]);const n=r(i);return l([n.mean(0),n.max(0)])})}}},M={__proto__:null,HCN:class{constructor({actions:t,featurizers:e,hiddenSize:s=32,optimizer:i=u.adam(.01),temperature:r=1,dropout:n=0}){this.actions=t,this.featurizers=e,this.optimizer=i,this.hiddenSize=s,this.outputSize=t.length,this.lstmTemperature=r,this.lstmDropout=n}async init(){await Promise.all(this.featurizers.map(t=>t.init(this.actions))),this.inputSize=this.featurizers.map(t=>t.size).reduce((t,e)=>t+e,1),this.lstm=new k(this.inputSize,this.hiddenSize,this.outputSize,this.lstmDropout),this.resetDialog()}resetDialog(){this.featurizers.forEach(t=>t.resetDialog()),({c:this.lstmC,h:this.lstmH}=this.lstm.initLSTM())}async handleQuery(t){return Promise.all(this.featurizers.map(e=>e.handleQuery(t)))}getOptimizableFeatures(s){return e(()=>{const e=this.featurizers.map((t,e)=>t.getOptimizableFeatures(s[e]));return e.push(t([1])),l(e)})}handleAction(t){this.featurizers.map(e=>e.handleAction(t))}getActionMask(){return e(()=>this.featurizers.map(t=>o(t.getActionMask(),void 0,"float32")).reduce((t,e)=>d(t,e),m([this.actions.length])))}async fitStory(t){this.resetDialog();const e=[],s=[],i=[];for(let r=0;r<t.length;r+=1){const n=t[r];e.push(await this.handleQuery(n.query)),s.push(this.getActionMask()),i.push(c(this.actions.indexOf(n.action),this.outputSize)),this.handleAction(n.action)}let n;return this.optimizer.minimize(()=>{let{c:t,h:a}=this.lstm.initLSTM(!1);const o=e.map((e,i)=>{const r=this.lstm.predict(this.getOptimizableFeatures(e),t,a,s[i]);return t=r.nc,a=r.nh,r.y}),c=r(i),h=r(o),l=g.categoricalCrossentropy(c,h).mean();return n={targets:p(c.argMax(1)),predictions:p(h.argMax(1)),loss:l.arraySync(),isFailing:g.categoricalAccuracy(c,h).mean().arraySync()<.999},l}),h([e,i]),n}async train({stories:t,nEpochs:s=12,onEpochEnd:i}){let r;for(let n=0;n<s;n+=1){const s=[],a=[],o=[],c=[];for(let e=0;e<t.length;e+=1){const i=await this.fitStory(t[e]);s.push(i.targets),a.push(i.predictions),o.push(i.loss),i.isFailing&&c.push(e)}const u=e(()=>y.confusionMatrix(l(s),l(a),this.outputSize)),d=e(()=>u.mul(f(...u.shape)).sum(0));r={epoch:n,failingSamples:c,accuracy:e(()=>d.sum().div(u.sum()).arraySync()),recall:e(()=>d.div(u.sum(1)).mean().arraySync()),precision:e(()=>d.div(u.sum(0)).mean().arraySync()),loss:o.reduce((t,e)=>t+e)/o.length},h(s),h(a),h([d,u]),void 0!==i&&i(r)}return this.resetDialog(),r}async predict(t){this.lstm.dropout=0;const s=this.getOptimizableFeatures(await this.handleQuery(t)),i=this.getActionMask(),r=this.lstm.predict(s,this.lstmC,this.lstmH,i,this.lstmTemperature);h([this.lstmC,this.lstmH]),this.lstmC=r.nc.clone(),this.lstmH=r.nh.clone();const n=e(()=>r.y.argMax().arraySync()),a=e(()=>r.y.arraySync()[n]);return h([s,i]),h(r),this.lstm.dropout=this.lstmDropout,this.handleAction(this.actions[n]),{action:this.actions[n],confidence:a}}async score(t){const s=[],i=[],r=[],n=[];for(let e=0;e<t.length;e+=1){this.resetDialog();for(let a=0;a<t[e].length;a+=1){const o=t[e][a],{action:c,confidence:h}=await this.predict(o.query);s.push(this.actions.indexOf(o.action)),i.push(this.actions.indexOf(c)),r.push(h),c===o.action||n.includes(e)||n.push(e)}}const a=e(()=>y.confusionMatrix(o(s),o(i),this.outputSize)),c=e(()=>a.mul(f(...a.shape)).sum(0)),l={failingSamples:n,accuracy:e(()=>c.sum().div(a.sum()).arraySync()),recall:e(()=>c.div(a.sum(1)).mean().arraySync()),precision:e(()=>c.div(a.sum(0)).mean().arraySync()),averageConfidence:r.reduce((t,e)=>t+e)/r.length};return h([c,a]),this.resetDialog(),l}load(t){const e=JSON.parse(t);this.featurizers.forEach(t=>{t.load(e[t.id])}),this.lstm.load(e.lstm),this.resetDialog()}async export(){const t={lstm:await this.lstm.export()};for(let e=0;e<this.featurizers.length;e+=1){const s=this.featurizers[e];t[s.id]=await s.export()}return JSON.stringify(t)}}};class C extends S{constructor(t,e){super(),this.dependantActions=t,this.invDependantActions=e}getActionMask(){return this.actions.map(t=>{const e=void 0!==this.value,s=this.dependantActions.includes(t),i=this.invDependantActions.includes(t);return!e&&(!s||i)||e&&!i})}resetDialog(){this.value=void 0}getValue(){return this.value}setValue(t){this.value=t}}var U={__proto__:null,Slot:C,CategoricalSlot:class extends C{constructor({name:t,categories:e,dependantActions:s=[],invDependantActions:i=[],threshold:r=.75}){super(s,i),this.categoryNames=Object.keys(e),this.categories=e,this.threshold=r,this.id=t+"#Categorical",this.size=2*this.categoryNames.length}async init(t){await super.init(t),this.resetDialog()}oneHotValue(t){const e=Object.keys(this.categories);return c(e.indexOf(t.category),e.length)}async handleQuery(t){const s=this.getValue();let i={category:void 0,extract:void 0,score:0};Object.entries(this.categories).forEach(([e,r])=>{const n=r.map(e=>x(t.toLowerCase(),e.toLowerCase())).filter(t=>t.score>=this.threshold).reduce((t,e)=>t.score>e.score?t:e,{extract:void 0,score:0});if(void 0!==n.extract){const t=e!==s.category,r=i.category===s.category,a=n.score>i.score;(void 0===i.category||t&&a||r&&t||r&&a)&&(i={category:e,...n})}});const r=e(()=>l([this.oneHotValue(i),this.oneHotValue(this.getValue())]));return void 0!==i.category&&this.setValue(i),r}getValue(){return void 0===super.getValue()?{category:void 0,extract:void 0,score:0}:super.getValue()}}},O={__proto__:null,parseStories:function(t){const e=[];let s=[],i=!0;return t.split("\n").forEach(t=>{const r=/^## *([^#].*)?$/gm.exec(t),n=/^> *(.*)$/gm.exec(t),a=/^- *(\w*)$/gm.exec(t);null!=r&&s.length>0?(s.push({query:"",action:"LUS"}),e.push(s),s=[]):null!=n?(s.length>0&&(void 0===s[s.length-1].action?s[s.length-1].action="LUS":s.push({query:"",action:"LUS"})),s.push({query:n[1],action:void 0}),i=!1):null!=a&&i?s.push({query:"",action:a[1]}):null==a||i||(s[s.length-1].action=a[1],i=!0)}),s.length>0&&(s.push({query:"",action:"LUS"}),e.push(s)),e},trainTestSplit:function(t,e){const s=[];for(let i=0;i/t.length<e;i+=1)s.push(...t.splice(Math.floor(Math.random()*t.length),1));return{train:t,test:s}},NLUFormatter:class{constructor({model:t,slots:e=[],LUSAction:s="LUS"}){this.model=t,this.slots=e,this.LUSAction=s}async ask(t){const e={query:t,actions:[],turnConfidence:1,slots:{}};let{action:s,confidence:i}=await this.model.predict(t);for(;s!==this.LUSAction;)e.actions.push(s),e.turnConfidence*=i,({action:s,confidence:i}=await this.model.predict(""));return this.slots.forEach(t=>{e.slots[t.id]=t.getValue()}),e}resetDialog(){this.model.resetDialog()}},KeyedVectors:class{constructor(t,e,s=.5){this.loaderFunction=t,this.size=e,this.maxDistance=s}async load(){this.vectors=JSON.parse(await this.loaderFunction())}isLoaded(){return void 0!==this.vectors}keys(){return Object.keys(this.vectors)}get(t){if(this.keys().includes(t))return v(this.vectors[t]);let e,s=Infinity;return this.keys().forEach(i=>{const r=A(i,t);r<s&&(e=i,s=r)}),s<=this.maxDistance?o(this.vectors[e]):void 0}}};export{D as featurizers,M as models,U as slots,O as tools,L as utils};
//# sourceMappingURL=wisty.modern.js.map
