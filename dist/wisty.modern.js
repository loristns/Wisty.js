import*as t from"@tensorflow/tfjs";import{tidy as e,basicLSTMCell as n,stack as r,dropout as i,sum as o,tensor as s,randomNormal as u,zeros as a,concat as c,mul as l,ones as h,metrics as f,keep as v,dispose as m,oneHot as d,math as p,eye as y,moments as g,train as b}from"@tensorflow/tfjs";import{load as P}from"@tensorflow-models/universal-sentence-encoder";var S=function(){function t(e,n,r,i){void 0===i&&(i=.2),this.lstmKernel=t.randomVariable([e+n,4*n]),this.lstmBias=t.randomVariable([4*n]),this.lstmForgetBias=t.randomVariable([1],!0),this.lstmInitH=t.randomVariable([1,n]),this.lstmInitC=t.randomVariable([1,n]),this.denseWeights=t.randomVariable([n,r]),this.denseBias=t.randomVariable([r]),this.dropout=i}t.randomVariable=function(t,n){return void 0===n&&(n=!1),e(function(){var e=u(t);return n&&(e=e.asScalar()),e.variable()})};var a=t.prototype;return a.initLSTM=function(t){return void 0===t&&(t=!0),{c:t?this.lstmInitC.clone():this.lstmInitC,h:t?this.lstmInitH.clone():this.lstmInitH}},a.predict=function(t,s,u,a,c){var l=this;return void 0===c&&(c=1),e(function(){var e=n(l.lstmForgetBias,l.lstmKernel,l.lstmBias,r([t]),u,s),h=e[0],f=e[1],v=i(f,l.dropout).matMul(l.denseWeights).add(l.denseBias).squeeze().div(c).softmax().mul(null!=a?a:1);return{y:v=v.div(o(v)),nc:h,nh:f}})},a.load=function(t){var n=this;e(function(){n.lstmKernel=s(t.lstmKernel).variable(),n.lstmBias=s(t.lstmBias).variable(),n.lstmForgetBias=s(t.lstmForgetBias).variable(),n.lstmInitH=s(t.lstmInitH).variable(),n.lstmInitC=s(t.lstmInitC).variable(),n.denseWeights=s(t.denseWeights).variable(),n.denseBias=s(t.denseBias).variable()})},a.export=function(){try{var t=this;return Promise.resolve(t.lstmKernel.array()).then(function(e){return Promise.resolve(t.lstmBias.array()).then(function(n){return Promise.resolve(t.lstmForgetBias.array()).then(function(r){return Promise.resolve(t.lstmInitH.array()).then(function(i){return Promise.resolve(t.lstmInitC.array()).then(function(o){return Promise.resolve(t.denseWeights.array()).then(function(s){return Promise.resolve(t.denseBias.array()).then(function(t){return{lstmKernel:e,lstmBias:n,lstmForgetBias:r,lstmInitH:i,lstmInitC:o,denseWeights:s,denseBias:t}})})})})})})})}catch(t){return Promise.reject(t)}},t}();const z=function(){function t(){}return t.prototype.then=function(e,n){const r=new t,i=this.s;if(i){const t=1&i?e:n;if(t){try{A(r,1,t(this.v))}catch(t){A(r,2,t)}return r}return this}return this.o=function(t){try{const i=t.v;1&t.s?A(r,1,e?e(i):i):n?A(r,1,n(i)):A(r,2,i)}catch(t){A(r,2,t)}},r},t}();function A(t,e,n){if(!t.s){if(n instanceof z){if(!n.s)return void(n.o=A.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(A.bind(null,t,e),A.bind(null,t,2));t.s=e,t.v=n;const r=t.o;r&&r(t)}}function x(t){return t instanceof z&&1&t.s}function j(t,e,n){for(var r;;){var i=t();if(x(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=n();if(o&&o.then){if(!x(o)){r=1;break}o=o.s}if(e){var s=e();if(s&&s.then&&!x(s)){r=2;break}}}var u=new z,a=A.bind(null,u,2);return(0===r?i.then(l):1===r?o.then(c):s.then(h)).then(void 0,a),u;function c(r){o=r;do{if(e&&(s=e())&&s.then&&!x(s))return void s.then(h).then(void 0,a);if(!(i=t())||x(i)&&!i.v)return void A(u,1,o);if(i.then)return void i.then(l).then(void 0,a);x(o=n())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,a)}function l(t){t?(o=n())&&o.then?o.then(c).then(void 0,a):c(o):A(u,1,o)}function h(){(i=t())?i.then?i.then(l).then(void 0,a):l(i):A(u,1,o)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var O=function(){function n(t,e,n,r,i){void 0===n&&(n=128),void 0===r&&(r=b.adam(.01)),void 0===i&&(i=.2),this.actions=t,this.featurizers=e,this.optimizer=r,this.hiddenSize=n,this.outputSize=t.length,this.lstmDropout=i}var i=n.prototype;return i.init=function(){try{var t=this;return Promise.resolve(Promise.all(t.featurizers.map(function(e){return e.init(t.actions)}))).then(function(){t.inputSize=t.featurizers.map(function(t){return t.size}).reduce(function(t,e){return t+e},1),t.lstm=new S(t.inputSize,t.hiddenSize,t.outputSize,t.lstmDropout),t.resetDialog()})}catch(t){return Promise.reject(t)}},i.resetDialog=function(){this.featurizers.forEach(function(t){return t.resetDialog()});var t=this.lstm.initLSTM();this.lstmC=t.c,this.lstmH=t.h},i.handleQuery=function(t){try{return Promise.all(this.featurizers.map(function(e){return e.handleQuery(t)}))}catch(t){return Promise.reject(t)}},i.getOptimizableFeatures=function(t){var n=this;return e(function(){var e=n.featurizers.map(function(e,n){return e.getOptimizableFeatures(t[n])});return e.push(a([1])),c(e)})},i.handleAction=function(t){this.featurizers.map(function(e){return e.handleAction(t)})},i.getActionMask=function(){var t=this;return e(function(){return t.featurizers.map(function(t){return s(t.getActionMask(),void 0,"float32")}).reduce(function(t,e){return l(t,e)},h([t.actions.length]))})},i.fitStory=function(t){try{var e=function(){var t;return n.optimizer.minimize(function(){var e=n.lstm.initLSTM(!1),u=e.c,a=e.h,c=i.map(function(t,e){var r=n.lstm.predict(n.getOptimizableFeatures(t),u,a,o[e]);return u=r.nc,a=r.nh,r.y}),l=r(s),h=r(c),m=f.categoricalCrossentropy(l,h).mean();return t={targets:v(l.argMax(1)),predictions:v(h.argMax(1)),loss:m.arraySync(),isFailing:f.categoricalAccuracy(l,h).mean().arraySync()<.999},m}),m([i,s]),t},n=this;n.resetDialog();var i=[],o=[],s=[],u=0,a=j(function(){return u<t.length},function(){return!!(u+=1)},function(){var e=t[u],r=i.push;return Promise.resolve(n.handleQuery(e.query)).then(function(t){r.call(i,t),o.push(n.getActionMask()),s.push(d(n.actions.indexOf(e.action),n.outputSize)),n.handleAction(e.action)})});return Promise.resolve(a&&a.then?a.then(e):e())}catch(t){return Promise.reject(t)}},i.train=function(n,r,i){void 0===r&&(r=12);try{var o,s=function(){return u.resetDialog(),o},u=this,a=0,l=j(function(){return a<r},function(){return!!(a+=1)},function(){function r(){var n=e(function(){return p.confusionMatrix(c(s),c(l),u.outputSize)}),r=e(function(){return n.mul(y.apply(t,n.shape)).sum(0)});o={epoch:a,failingSamples:f,accuracy:e(function(){return r.sum().div(n.sum()).arraySync()}),recall:e(function(){return r.div(n.sum(1)).mean().arraySync()}),precision:e(function(){return r.div(n.sum(0)).mean().arraySync()}),loss:h.reduce(function(t,e){return t+e})/h.length},m(s),m(l),m([r,n]),void 0!==i&&i(o)}var s=[],l=[],h=[],f=[],v=0,d=j(function(){return v<n.length},function(){return!!(v+=1)},function(){return Promise.resolve(u.fitStory(n[v])).then(function(t){s.push(t.targets),l.push(t.predictions),h.push(t.loss),t.isFailing&&f.push(v)})});return d&&d.then?d.then(r):r()});return Promise.resolve(l&&l.then?l.then(s):s())}catch(t){return Promise.reject(t)}},i.predict=function(t,n,i){void 0===n&&(n=1),void 0===i&&(i=1);try{var o=this;o.lstm.dropout=1===n?0:o.lstmDropout;var s=o.getOptimizableFeatures;return Promise.resolve(o.handleQuery(t)).then(function(t){for(var u,a=s.call(o,t),c=o.getActionMask(),l=[],h=0;h<n;h+=1)m(u),u=o.lstm.predict(a,o.lstmC,o.lstmH,c,i),l.push(u.y);m([o.lstmC,o.lstmH]),o.lstmC=u.nc.clone(),o.lstmH=u.nh.clone();var f=e(function(){return g(r(l),0)}),v=f.mean,d=f.variance,p=e(function(){return v.argMax().arraySync()}),y=e(function(){return v.sub(d.sqrt()).arraySync()[p]});return m([a,c,v,d]),m(u),m(l),o.handleAction(o.actions[p]),{action:o.actions[p],confidence:y}})}catch(t){return Promise.reject(t)}},i.score=function(n,r,i){void 0===r&&(r=1),void 0===i&&(i=1);try{var o=function(){var n=e(function(){return p.confusionMatrix(s(a),s(c),u.outputSize)}),r=e(function(){return n.mul(y.apply(t,n.shape)).sum(0)}),i={failingSamples:h,accuracy:e(function(){return r.sum().div(n.sum()).arraySync()}),recall:e(function(){return r.div(n.sum(1)).mean().arraySync()}),precision:e(function(){return r.div(n.sum(0)).mean().arraySync()}),averageConfidence:l.reduce(function(t,e){return t+e})/l.length};return m([r,n]),u.resetDialog(),i},u=this,a=[],c=[],l=[],h=[],f=0,v=j(function(){return f<n.length},function(){return!!(f+=1)},function(){u.resetDialog();var t=0,e=j(function(){return t<n[f].length},function(){return!!(t+=1)},function(){var e=n[f][t];return Promise.resolve(u.predict(e.query,r,i)).then(function(t){var n=t.action,r=t.confidence;a.push(u.actions.indexOf(e.action)),c.push(u.actions.indexOf(n)),l.push(r),n===e.action||h.includes(f)||h.push(f)})});if(e&&e.then)return e.then(function(){})});return Promise.resolve(v&&v.then?v.then(o):o())}catch(t){return Promise.reject(t)}},i.load=function(t){var e=JSON.parse(t);this.featurizers.forEach(function(t){t.load(e[t.id])}),this.lstm.load(e.lstm),this.resetDialog()},i.export=function(){try{var t=this;return Promise.resolve(t.lstm.export()).then(function(e){function n(){return JSON.stringify(r)}var r={lstm:e},i=0,o=j(function(){return i<t.featurizers.length},function(){return!!(i+=1)},function(){var e=t.featurizers[i];return Promise.resolve(e.export()).then(function(t){r[e.id]=t})});return o&&o.then?o.then(n):n()})}catch(t){return Promise.reject(t)}},n}();function k(){return(k=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function M(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var B=function(){function t(){}var e=t.prototype;return e.init=function(t){try{return this.actions=t,Promise.resolve()}catch(t){return Promise.reject(t)}},e.getOptimizableFeatures=function(t){return t},e.handleAction=function(t){},e.getActionMask=function(){return this.actions.map(function(){return!0})},e.resetDialog=function(){},e.load=function(t){},e.export=function(){return Promise.resolve({})},t}(),C=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).id="Universal Sentence Encoder",e.size=512,e}M(e,t);var n=e.prototype;return n.init=function(e){try{var n=this;return Promise.resolve(t.prototype.init.call(n,e)).then(function(){return Promise.resolve(P()).then(function(t){return n.encoder=t,Promise.resolve(n.encodeQuery("")).then(function(t){n.emptyEncoding=t})})})}catch(t){return Promise.reject(t)}},n.encodeQuery=function(t){try{return Promise.resolve(this.encoder.embed([t])).then(function(t){var e=t.squeeze();return m(t),e})}catch(t){return Promise.reject(t)}},n.handleQuery=function(t){try{return Promise.resolve(t?this.encodeQuery(t):this.emptyEncoding.clone())}catch(t){return Promise.reject(t)}},e}(B);function D(t){for(var e=0,n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}var I=function(t){function n(e){var n;return(n=t.call(this)||this).id="Bag-of-Words",n.size=e,n}return M(n,t),n.prototype.handleQuery=function(t){try{var n=this;return Promise.resolve(e(function(){var e=t.toLowerCase().split(/\W/g).map(function(t){return D(t)%n.size});return d(e,n.size).asType("float32").sum(0)}))}catch(t){return Promise.reject(t)}},n}(B);function F(t,e){for(var n=Array.from(Array(t.length+1),function(){return new Array(e.length+1).fill(0)}),r=1;r<=t.length;r+=1)n[r][0]=r;for(var i=1;i<=e.length;i+=1)n[0][i]=i;for(var o=0;o<e.length;o+=1)for(var s=0;s<t.length;s+=1)n[s+1][o+1]=Math.min(n[s][o+1]+1,n[s+1][o]+1,n[s][o]+(t[s]!==e[o]?1:0));return n[t.length][e.length]/Math.max(t.length,e.length,1)}var L=function(t){function n(e,n){var r;return(r=t.call(this)||this).id="Word Embedding",r.size=2*n,r.loaderFunction=e,r}M(n,t);var i=n.prototype;return i.init=function(e){try{var n=this;return Promise.resolve(t.prototype.init.call(n,e)).then(function(){return Promise.resolve(n.loaderFunction()).then(function(t){n.vectors=JSON.parse(t)})})}catch(t){return Promise.reject(t)}},i.handleQuery=function(t){try{var n=this;return Promise.resolve(e(function(){var e=t.toLowerCase().split(/\W/g).filter(function(t){return t.length>0}),i=[];if(e.forEach(function(t){if(Object.keys(n.vectors).includes(t))i.push(s(n.vectors[t]));else{var e,r=Infinity;Object.keys(n.vectors).forEach(function(n){var i=F(n,t);i<r&&(e=n,r=i)}),r<.5&&i.push(s(n.vectors[e]))}}),0===i.length)return a([n.size]);var o=r(i);return c([o.mean(0),o.max(0)])}))}catch(t){return Promise.reject(t)}},n}(B);function w(t,e){for(var n={extract:void 0,score:0},r=0;r<t.length;r+=1){var i=t.substring(r,r+e.length),o={extract:i,score:1-F(i,e)};if(1===o.score)return o;o.score>n.score&&(n=o)}return n}var Q=function(t){function n(e,n,r,i){var o;return void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=.75),(o=t.call(this)||this).categoryNames=Object.keys(e),o.categories=e,o.id="Categorical Slot ("+D(JSON.stringify(o.categoryNames))+")",o.dependantActions=n,o.inverselyDependantActions=r,o.threshold=i,o.size=2*o.categoryNames.length,o}M(n,t);var r=n.prototype;return r.init=function(e){try{var n=this;return Promise.resolve(t.prototype.init.call(n,e)).then(function(){n.resetDialog()})}catch(t){return Promise.reject(t)}},r.featurizeValue=function(t){var e=Object.keys(this.categories);return d(e.indexOf(t.category),e.length)},r.handleQuery=function(t){try{var n=this,r={category:void 0,extract:void 0,score:0};Object.entries(n.categories).forEach(function(e){var i=e[0],o=e[1].map(function(e){return w(t.toLowerCase(),e.toLowerCase())}).filter(function(t){return t.score>=n.threshold}).reduce(function(t,e){return t.score>e.score?t:e},{extract:void 0,score:0});o.score>r.score&&(r=k({category:i},o))});var i=e(function(){return c([n.featurizeValue(r),n.featurizeValue(n.value)])});return void 0!==r.category&&(n.value=r),Promise.resolve(i)}catch(t){return Promise.reject(t)}},r.getActionMask=function(){var t=this;return this.actions.map(function(e){var n=void 0===t.value.extract,r=t.dependantActions.includes(e),i=t.inverselyDependantActions.includes(e);return n&&(i||!r)||!n&&!i})},r.resetDialog=function(){this.value={category:void 0,extract:void 0,score:0}},r.getValue=function(){return this.value},n}(B),V=function(t){function n(e,n,r){var i;return void 0===e&&(e=!0),void 0===n&&(n=!0),void 0===r&&(r="LUS"),(i=t.call(this)||this).id="Action Featurizer",i.maskLUS=e,i.maskPreviousAction=n,i.LUSAction=r,i.resetDialog(),i}M(n,t);var r=n.prototype;return r.init=function(n){try{var r=this;return Promise.resolve(t.prototype.init.call(r,n)).then(function(){r.size=n.length,r.embeddings=e(function(){return u([r.size,r.size]).variable()})})}catch(t){return Promise.reject(t)}},r.handleQuery=function(t){try{var n=this;return Promise.resolve(e(function(){return n.userTalked=""!==t,d([n.actions.indexOf(n.previousAction)],n.actions.length)}))}catch(t){return Promise.reject(t)}},r.getOptimizableFeatures=function(t){return t.matMul(this.embeddings).squeeze()},r.handleAction=function(t){this.previousAction=t!==this.LUSAction?t:this.previousAction},r.getActionMask=function(){var e=t.prototype.getActionMask.call(this);return this.maskLUS&&this.userTalked&&(e[this.actions.indexOf(this.LUSAction)]=!1),this.maskPreviousAction&&this.actions.includes(this.previousAction)&&(e[this.actions.indexOf(this.previousAction)]=!1),e},r.resetDialog=function(){this.userTalked=!1,this.previousAction=void 0},r.load=function(t){this.embeddings=e(function(){return s(t.embeddings).variable()})},r.export=function(){try{return Promise.resolve(this.embeddings.array()).then(function(t){return{embeddings:t}})}catch(t){return Promise.reject(t)}},n}(B);function q(t){var e=[],n=[],r=!0;return t.split("\n").forEach(function(t){var i=/^## *([^#].*)?$/gm.exec(t),o=/^> *(.*)$/gm.exec(t),s=/^- *(\w*)$/gm.exec(t);null!=i&&n.length>0?(n.push({query:"",action:"LUS"}),e.push(n),n=[]):null!=o?(n.length>0&&n.push({query:"",action:"LUS"}),n.push({query:o[1],action:void 0}),r=!1):null!=s&&r?n.push({query:"",action:s[1]}):null==s||r||(n[n.length-1].action=s[1],r=!0)}),n.length>0&&(n.push({query:"",action:"LUS"}),e.push(n)),e}export{V as ActionFeaturizer,I as BOW,Q as CategoricalSlot,B as Featurizer,O as HCN,S as LSTM,C as USE,L as WordEmbedding,w as fuzzyMatch,D as hashcode,q as parseStories};
//# sourceMappingURL=wisty.modern.js.map
