var t=require("@tensorflow/tfjs"),e=require("@tensorflow-models/universal-sentence-encoder"),n=require("commonmark"),r=function(){function e(){this.size=1}var n=e.prototype;return n.init=function(t){try{return this.actions=t,Promise.resolve()}catch(t){return Promise.reject(t)}},n.handleQuery=function(t){return Promise.resolve()},n.getOptimizableFeatures=function(e){return void 0===e?t.zeros([1]):e},n.handleAction=function(t){},n.getActionMask=function(){return this.actions.map(function(){return!0})},n.resetDialog=function(){},n.load=function(t){},n.export=function(){return Promise.resolve({})},e}();function i(){return(i=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function o(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function s(t,e){for(var n=Array.from(Array(t.length+1),function(){return new Array(e.length+1).fill(0)}),r=1;r<=t.length;r+=1)n[r][0]=r;for(var i=1;i<=e.length;i+=1)n[0][i]=i;for(var o=0;o<e.length;o+=1)for(var s=0;s<t.length;s+=1)n[s+1][o+1]=Math.min(n[s][o+1]+1,n[s+1][o]+1,n[s][o]+(t[s]!==e[o]?1:0));return n[t.length][e.length]/Math.max(t.length,e.length,1)}function a(t,e){for(var n={extract:void 0,score:0},r=0;r<t.length;r+=1){var i=t.substring(r,r+e.length),o={extract:i,score:1-s(i,e)};if(1===o.score)return o;o.score>n.score&&(n=o)}return n}function u(t){for(var e=0,n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}function c(e,n,r){return void 0===n&&(n=!1),void 0===r&&(r="he"),t.tidy(function(){var i;switch(r){case"he":i=t.initializers.heNormal({});break;case"zeros":i=t.initializers.zeros();break;case"normal":i=t.initializers.randomNormal({});break;default:throw new Error("Expected parameter init to take value 'he', 'zeros' or 'normal' not '"+r+"'.")}var o=i.apply(e);return n&&(o=o.asScalar()),o.variable()})}var l=function(){function e(t,e,n,r){void 0===r&&(r=.2),this.lstmKernel=c([t+e,4*e]),this.lstmBias=c([4*e],!1,"zeros"),this.lstmForgetBias=c([1],!0,"zeros"),this.lstmInitH=c([1,e]),this.lstmInitC=c([1,e]),this.denseWeights=c([e,n]),this.denseBias=c([n],!1,"zeros"),this.dropout=r}var n=e.prototype;return n.initLSTM=function(t){return void 0===t&&(t=!0),{c:t?this.lstmInitC.clone():this.lstmInitC,h:t?this.lstmInitH.clone():this.lstmInitH}},n.predict=function(e,n,r,i,o){var s=this;return void 0===o&&(o=1),t.tidy(function(){var a=t.basicLSTMCell(s.lstmForgetBias,s.lstmKernel,s.lstmBias,t.stack([e]),r,n),u=a[0],c=a[1],l=t.dropout(c,s.dropout).matMul(s.denseWeights).add(s.denseBias).squeeze().div(o).softmax().mul(null!=i?i:1);return{y:l=l.div(t.sum(l)),nc:u,nh:c}})},n.load=function(e){var n=this;t.tidy(function(){n.lstmKernel=t.tensor(e.lstmKernel).variable(),n.lstmBias=t.tensor(e.lstmBias).variable(),n.lstmForgetBias=t.tensor(e.lstmForgetBias).variable(),n.lstmInitH=t.tensor(e.lstmInitH).variable(),n.lstmInitC=t.tensor(e.lstmInitC).variable(),n.denseWeights=t.tensor(e.denseWeights).variable(),n.denseBias=t.tensor(e.denseBias).variable()})},n.export=function(){try{var t=this;return Promise.resolve(t.lstmKernel.array()).then(function(e){return Promise.resolve(t.lstmBias.array()).then(function(n){return Promise.resolve(t.lstmForgetBias.array()).then(function(r){return Promise.resolve(t.lstmInitH.array()).then(function(i){return Promise.resolve(t.lstmInitC.array()).then(function(o){return Promise.resolve(t.denseWeights.array()).then(function(s){return Promise.resolve(t.denseBias.array()).then(function(t){return{lstmKernel:e,lstmBias:n,lstmForgetBias:r,lstmInitH:i,lstmInitC:o,denseWeights:s,denseBias:t}})})})})})})})}catch(t){return Promise.reject(t)}},e}(),h=function(){function t(t,e){this.key=t,this.parent=e,this.childs={},this.ending=!1}var e=t.prototype;return e.addChild=function(t){this.childs[t.key]=t},e.setEnding=function(){this.ending=!0},t}(),d=function(){function t(){this.root=new h("",null)}var e=t.prototype;return e.add=function(t){for(var e=this.root,n=0;n<t.length;n+=1)void 0===e.childs[t[n]]&&e.addChild(new h(t[n],e)),e=e.childs[t[n]],n===t.length-1&&e.setEnding()},e.split=function(t,e,n){void 0===e&&(e=void 0),void 0===n&&(n=[]);var r=[];function i(t){r[r.length-1]===e||n.includes(t)||r.push(e)}for(var o=this.root,s="",a=0;a<t.length;a+=1){var u=t[a];void 0!==o.childs[u]?(s+=u,o=o.childs[u]):(o.ending?r.push(s):i(s),void 0!==this.root.childs[u]?(s=u,o=this.root.childs[u]):(i(s),s="",o=this.root))}return o.ending?r.push(s):i(s),r},t}(),f={__proto__:null,fuzzyMatch:a,hashcode:u,initializeVariable:c,levenshteinDistance:s,LSTM:l,Trie:d},v={__proto__:null,Featurizer:r,ActionFeaturizer:function(e){function n(t){var n,r=void 0===t?{maskLUS:!0,maskPreviousAction:!0,LUSAction:"LUS"}:t,i=r.maskLUS,o=void 0===i||i,s=r.maskPreviousAction,a=void 0===s||s,u=r.LUSAction,c=void 0===u?"LUS":u;return(n=e.call(this)||this).id="Action Featurizer",n.maskLUS=o,n.maskPreviousAction=a,n.LUSAction=c,n.resetDialog(),n}o(n,e);var r=n.prototype;return r.init=function(t){try{var n=this;return Promise.resolve(e.prototype.init.call(n,t)).then(function(){n.size=t.length,n.embeddings=c([n.size,n.size])})}catch(t){return Promise.reject(t)}},r.handleQuery=function(e){try{var n=this;return Promise.resolve(t.tidy(function(){return n.userTalked=""!==e,t.oneHot([n.actions.indexOf(n.previousAction)],n.actions.length)}))}catch(t){return Promise.reject(t)}},r.getOptimizableFeatures=function(t){return t.matMul(this.embeddings).squeeze()},r.handleAction=function(t){this.previousAction=t!==this.LUSAction?t:this.previousAction},r.getActionMask=function(){var t=e.prototype.getActionMask.call(this);return this.maskLUS&&this.userTalked&&(t[this.actions.indexOf(this.LUSAction)]=!1),this.maskPreviousAction&&this.actions.includes(this.previousAction)&&(t[this.actions.indexOf(this.previousAction)]=!1),t},r.resetDialog=function(){this.userTalked=!1,this.previousAction=void 0},r.load=function(e){this.embeddings=t.tidy(function(){return t.tensor(e.embeddings).variable()})},r.export=function(){try{return Promise.resolve(this.embeddings.array()).then(function(t){return{embeddings:t}})}catch(t){return Promise.reject(t)}},n}(r),BOW:function(e){function n(t){var n;return(n=e.call(this)||this).id="Bag-of-Words",n.size=t,n}return o(n,e),n.prototype.handleQuery=function(e){try{var n=this;return Promise.resolve(t.tidy(function(){var r=e.toLowerCase().split(/\W/g).map(function(t){return u(t)%n.size});return t.oneHot(r,n.size).asType("float32").sum(0)}))}catch(t){return Promise.reject(t)}},n}(r),USE:function(n){function r(){var t;return(t=n.apply(this,arguments)||this).id="Universal Sentence Encoder",t.size=512,t}o(r,n);var i=r.prototype;return i.init=function(t){try{var r=this;return Promise.resolve(n.prototype.init.call(r,t)).then(function(){return Promise.resolve(e.load()).then(function(t){return r.encoder=t,Promise.resolve(r.encodeQuery("")).then(function(t){r.emptyEncoding=t})})})}catch(t){return Promise.reject(t)}},i.encodeQuery=function(e){try{return Promise.resolve(this.encoder.embed([e])).then(function(e){var n=e.squeeze();return t.dispose(e),n})}catch(t){return Promise.reject(t)}},i.handleQuery=function(t){try{return Promise.resolve(t?this.encodeQuery(t):this.emptyEncoding.clone())}catch(t){return Promise.reject(t)}},r}(r),WordEmbedding:function(e){function n(t){var n;return(n=e.call(this)||this).id="Word Embedding",n.size=2*t.size,n.vectors=t,n}o(n,e);var r=n.prototype;return r.init=function(t){try{var n=this;return Promise.resolve(e.prototype.init.call(n,t)).then(function(){var t=function(){if(!n.vectors.isLoaded())return Promise.resolve(n.vectors.load()).then(function(){})}();if(t&&t.then)return t.then(function(){})})}catch(t){return Promise.reject(t)}},r.handleQuery=function(e){try{var n=this;return Promise.resolve(t.tidy(function(){var r=n.vectors.tokenize(e).map(function(t){return n.vectors.get(t)}).filter(function(t){return void 0!==t});if(0===r.length)return t.zeros([n.size]);var i=t.stack(r);return t.concat([i.mean(0),i.max(0)])}))}catch(t){return Promise.reject(t)}},n}(r)};function m(t,e,n){if(!t.s){if(n instanceof p){if(!n.s)return void(n.o=m.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(m.bind(null,t,e),m.bind(null,t,2));t.s=e,t.v=n;var r=t.o;r&&r(t)}}var p=function(){function t(){}return t.prototype.then=function(e,n){var r=new t,i=this.s;if(i){var o=1&i?e:n;if(o){try{m(r,1,o(this.v))}catch(t){m(r,2,t)}return r}return this}return this.o=function(t){try{var i=t.v;1&t.s?m(r,1,e?e(i):i):n?m(r,1,n(i)):m(r,2,i)}catch(t){m(r,2,t)}},r},t}();function y(t){return t instanceof p&&1&t.s}function g(t,e,n){for(var r;;){var i=t();if(y(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=n();if(o&&o.then){if(!y(o)){r=1;break}o=o.s}if(e){var s=e();if(s&&s.then&&!y(s)){r=2;break}}}var a=new p,u=m.bind(null,a,2);return(0===r?i.then(l):1===r?o.then(c):s.then(h)).then(void 0,u),a;function c(r){o=r;do{if(e&&(s=e())&&s.then&&!y(s))return void s.then(h).then(void 0,u);if(!(i=t())||y(i)&&!i.v)return void m(a,1,o);if(i.then)return void i.then(l).then(void 0,u);y(o=n())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,u)}function l(t){t?(o=n())&&o.then?o.then(c).then(void 0,u):c(o):m(a,1,o)}function h(){(i=t())?i.then?i.then(l).then(void 0,u):l(i):m(a,1,o)}}var z,S={__proto__:null,HCN:function(){function e(e){var n=e.actions,r=e.featurizers,i=e.hiddenSize,o=void 0===i?32:i,s=e.optimizer,a=void 0===s?t.train.adam(.01):s,u=e.temperature,c=void 0===u?1:u,l=e.dropout,h=void 0===l?0:l;this.actions=n,this.featurizers=r,this.optimizer=a,this.hiddenSize=o,this.outputSize=n.length,this.lstmTemperature=c,this.lstmDropout=h}var n=e.prototype;return n.init=function(){try{var t=this;return Promise.resolve(Promise.all(t.featurizers.map(function(e){return e.init(t.actions)}))).then(function(){t.inputSize=t.featurizers.map(function(t){return t.size}).reduce(function(t,e){return t+e},1),t.lstm=new l(t.inputSize,t.hiddenSize,t.outputSize,t.lstmDropout),t.resetDialog()})}catch(t){return Promise.reject(t)}},n.resetDialog=function(){this.featurizers.forEach(function(t){return t.resetDialog()});var t=this.lstm.initLSTM();this.lstmC=t.c,this.lstmH=t.h},n.handleQuery=function(t){try{return Promise.all(this.featurizers.map(function(e){return e.handleQuery(t)}))}catch(t){return Promise.reject(t)}},n.getOptimizableFeatures=function(e){var n=this;return t.tidy(function(){var r=n.featurizers.map(function(t,n){return t.getOptimizableFeatures(e[n])});return r.push(t.zeros([1])),t.concat(r)})},n.handleAction=function(t){this.featurizers.map(function(e){return e.handleAction(t)})},n.getActionMask=function(){var e=this;return t.tidy(function(){return e.featurizers.map(function(e){return t.tensor(e.getActionMask(),void 0,"float32")}).reduce(function(e,n){return t.mul(e,n)},t.ones([e.actions.length]))})},n.fitStory=function(e){try{var n=function(){var e;return r.optimizer.minimize(function(){var n=r.lstm.initLSTM(!1),a=n.c,u=n.h,c=i.map(function(t,e){var n=r.lstm.predict(r.getOptimizableFeatures(t),a,u,o[e]);return a=n.nc,u=n.nh,n.y}),l=t.stack(s),h=t.stack(c),d=t.metrics.categoricalCrossentropy(l,h).mean();return e={targets:t.keep(l.argMax(1)),predictions:t.keep(h.argMax(1)),loss:d.arraySync(),isFailing:t.metrics.categoricalAccuracy(l,h).mean().arraySync()<.999},d}),t.dispose([i,s]),e},r=this;r.resetDialog();var i=[],o=[],s=[],a=0,u=g(function(){return a<e.length},function(){return!!(a+=1)},function(){var n=e[a],u=i.push;return Promise.resolve(r.handleQuery(n.query)).then(function(e){u.call(i,e),o.push(r.getActionMask()),s.push(t.oneHot(r.actions.indexOf(n.action),r.outputSize)),r.handleAction(n.action)})});return Promise.resolve(u&&u.then?u.then(n):n())}catch(t){return Promise.reject(t)}},n.train=function(e){var n=e.stories,r=e.nEpochs,i=void 0===r?12:r,o=e.onEpochEnd,s=void 0===o?void 0:o;try{var a,u=function(){return c.resetDialog(),a},c=this,l=0,h=g(function(){return l<i},function(){return!!(l+=1)},function(){function e(){var e=t.tidy(function(){return t.math.confusionMatrix(t.concat(r),t.concat(i),c.outputSize)}),n=t.tidy(function(){return e.mul(t.eye.apply(t,e.shape)).sum(0)});a={epoch:l,failingSamples:u,accuracy:t.tidy(function(){return n.sum().div(e.sum()).arraySync()}),recall:t.tidy(function(){return n.div(e.sum(1)).mean().arraySync()}),precision:t.tidy(function(){return n.div(e.sum(0)).mean().arraySync()}),loss:o.reduce(function(t,e){return t+e})/o.length},t.dispose(r),t.dispose(i),t.dispose([n,e]),void 0!==s&&s(a)}var r=[],i=[],o=[],u=[],h=0,d=g(function(){return h<n.length},function(){return!!(h+=1)},function(){return Promise.resolve(c.fitStory(n[h])).then(function(t){r.push(t.targets),i.push(t.predictions),o.push(t.loss),t.isFailing&&u.push(h)})});return d&&d.then?d.then(e):e()});return Promise.resolve(h&&h.then?h.then(u):u())}catch(t){return Promise.reject(t)}},n.predict=function(e){try{var n=this;n.lstm.dropout=0;var r=n.getOptimizableFeatures;return Promise.resolve(n.handleQuery(e)).then(function(e){var i=r.call(n,e),o=n.getActionMask(),s=n.lstm.predict(i,n.lstmC,n.lstmH,o,n.lstmTemperature);t.dispose([n.lstmC,n.lstmH]),n.lstmC=s.nc.clone(),n.lstmH=s.nh.clone();var a=t.tidy(function(){return s.y.argMax().arraySync()}),u=t.tidy(function(){return s.y.arraySync()[a]});return t.dispose([i,o]),t.dispose(s),n.lstm.dropout=n.lstmDropout,n.handleAction(n.actions[a]),{action:n.actions[a],confidence:u}})}catch(t){return Promise.reject(t)}},n.score=function(e){try{var n=function(){var e=t.tidy(function(){return t.math.confusionMatrix(t.tensor(i),t.tensor(o),r.outputSize)}),n=t.tidy(function(){return e.mul(t.eye.apply(t,e.shape)).sum(0)}),u={failingSamples:a,accuracy:t.tidy(function(){return n.sum().div(e.sum()).arraySync()}),recall:t.tidy(function(){return n.div(e.sum(1)).mean().arraySync()}),precision:t.tidy(function(){return n.div(e.sum(0)).mean().arraySync()}),averageConfidence:s.reduce(function(t,e){return t+e})/s.length};return t.dispose([n,e]),r.resetDialog(),u},r=this,i=[],o=[],s=[],a=[],u=0,c=g(function(){return u<e.length},function(){return!!(u+=1)},function(){r.resetDialog();var t=0,n=g(function(){return t<e[u].length},function(){return!!(t+=1)},function(){var n=e[u][t];return Promise.resolve(r.predict(n.query)).then(function(t){var e=t.action,c=t.confidence;i.push(r.actions.indexOf(n.action)),o.push(r.actions.indexOf(e)),s.push(c),e===n.action||a.includes(u)||a.push(u)})});if(n&&n.then)return n.then(function(){})});return Promise.resolve(c&&c.then?c.then(n):n())}catch(t){return Promise.reject(t)}},n.load=function(t){var e=JSON.parse(t);this.featurizers.forEach(function(t){t.load(e[t.id])}),this.lstm.load(e.lstm),this.resetDialog()},n.export=function(){try{var t=this;return Promise.resolve(t.lstm.export()).then(function(e){function n(){return JSON.stringify(r)}var r={lstm:e},i=0,o=g(function(){return i<t.featurizers.length},function(){return!!(i+=1)},function(){var e=t.featurizers[i];return Promise.resolve(e.export()).then(function(t){r[e.id]=t})});return o&&o.then?o.then(n):n()})}catch(t){return Promise.reject(t)}},e}()},k=function(t){function e(e,n){var r;return(r=t.call(this)||this).dependantActions=e,r.invDependantActions=n,r}o(e,t);var n=e.prototype;return n.getActionMask=function(){var t=this;return this.actions.map(function(e){var n=void 0!==t.value,r=t.dependantActions.includes(e),i=t.invDependantActions.includes(e);return!n&&(!r||i)||n&&!i})},n.resetDialog=function(){this.value=void 0},n.getValue=function(){return this.value},n.setValue=function(t){this.value=t},e}(r),P={__proto__:null,Slot:k,CategoricalSlot:function(e){function n(t){var n,r=t.name,i=t.categories,o=t.dependantActions,s=t.invDependantActions,a=t.threshold,u=void 0===a?.75:a;return(n=e.call(this,void 0===o?[]:o,void 0===s?[]:s)||this).categoryNames=Object.keys(i),n.categories=i,n.threshold=u,n.id=r+"#Categorical",n.size=2*n.categoryNames.length,n}o(n,e);var r=n.prototype;return r.init=function(t){try{var n=this;return Promise.resolve(e.prototype.init.call(n,t)).then(function(){n.resetDialog()})}catch(t){return Promise.reject(t)}},r.oneHotValue=function(e){var n=Object.keys(this.categories);return t.oneHot(n.indexOf(e.category),n.length)},r.handleQuery=function(e){try{var n=this,r=n.getValue(),o={category:void 0,extract:void 0,score:0};Object.entries(n.categories).forEach(function(t){var s=t[0],u=t[1].map(function(t){return a(e.toLowerCase(),t.toLowerCase())}).filter(function(t){return t.score>=n.threshold}).reduce(function(t,e){return t.score>e.score?t:e},{extract:void 0,score:0});if(void 0!==u.extract){var c=s!==r.category,l=o.category===r.category,h=u.score>o.score;(void 0===o.category||c&&h||l&&c||l&&h)&&(o=i({category:s},u))}});var s=t.tidy(function(){return t.concat([n.oneHotValue(o),n.oneHotValue(n.getValue())])});return void 0!==o.category&&n.setValue(o),Promise.resolve(s)}catch(t){return Promise.reject(t)}},r.getValue=function(){return void 0===e.prototype.getValue.call(this)?{category:void 0,extract:void 0,score:0}:e.prototype.getValue.call(this)},n}(k)};function b(t,e,n){if(!t.s){if(n instanceof x){if(!n.s)return void(n.o=b.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(b.bind(null,t,e),b.bind(null,t,2));t.s=e,t.v=n;var r=t.o;r&&r(t)}}!function(t){t[t.query=0]="query",t[t.data=1]="data",t[t.action=2]="action",t[t.empty=3]="empty"}(z||(z={}));var x=function(){function t(){}return t.prototype.then=function(e,n){var r=new t,i=this.s;if(i){var o=1&i?e:n;if(o){try{b(r,1,o(this.v))}catch(t){b(r,2,t)}return r}return this}return this.o=function(t){try{var i=t.v;1&t.s?b(r,1,e?e(i):i):n?b(r,1,n(i)):b(r,2,i)}catch(t){b(r,2,t)}},r},t}();function w(t){return t instanceof x&&1&t.s}var A={__proto__:null,parseStories:function(t){var e=[],n=[],r=!0;return t.split("\n").forEach(function(t){var i=/^## *([^#].*)?$/gm.exec(t),o=/^> *(.*)$/gm.exec(t),s=/^- *(\w*)$/gm.exec(t);null!=i&&n.length>0?(n.push({query:"",action:"LUS"}),e.push(n),n=[]):null!=o?(n.length>0&&(void 0===n[n.length-1].action?n[n.length-1].action="LUS":n.push({query:"",action:"LUS"})),n.push({query:o[1],action:void 0}),r=!1):null!=s&&r?n.push({query:"",action:s[1]}):null==s||r||(n[n.length-1].action=s[1],r=!0)}),n.length>0&&(n.push({query:"",action:"LUS"}),e.push(n)),e},parseWistyML:function(t){var e=new n.Parser({smart:!0}).parse(t).walker(),r=e.next(),o={section:void 0,status:void 0,slot:void 0,sentence:"",extractedValues:[],storyName:void 0,story:[],currentState:void 0,stateStep:z.empty},s={stories:{},extractedValues:{}};function a(){void 0!==o.storyName&&(o.story.push(o.currentState),o.story.push({query:"",action:"LUS"}),s.stories[o.storyName]=o.story,o.storyName=void 0,o.story=[],o.currentState=void 0,o.stateStep=z.empty)}function u(t){var e;void 0===s.extractedValues[o.slot]&&(s.extractedValues[o.slot]=[]),(e=s.extractedValues[o.slot]).push.apply(e,o.extractedValues.map(function(e){return i({sentence:t},e)})),o.extractedValues=[],o.sentence=""}for(;null!==r;){var c=r.entering,l=r.node,h=l.type,d=l.literal,f=l.destination,v=l.info,m=l.level;if(c&&"heading"===h&&2===m)o.status="new-section",a();else if("text"===h&&"new-section"===o.status)o.section=d,o.status=d+".entering";else if("wisty.slots"===o.section)c&&"heading"===h&&3===m?o.status="slots.new-slot":"text"===h&&"slots.new-slot"===o.status?(d in s.extractedValues||(s.extractedValues[d]=[]),o.slot=d,o.status="slots.in-slot"):c&&"item"===h&&"slots.in-slot"===o.status?o.status="slots.in-sample":"text"===h&&"slots.in-sample"===o.status?o.sentence+=d:"code"===h&&"slots.in-sample"===o.status?(o.extractedValues.push({extract:d,start:o.sentence.length,end:o.sentence.length+d.length-1}),o.sentence+=d):c||"item"!==h||"slots.in-sample"!==o.status||(u(o.sentence),o.status="slots.in-slot");else if("wisty.stories"===o.section)if(c&&"heading"===h&&3===m)o.status="stories.new-story",a();else if("text"===h&&"stories.new-story"===o.status)o.storyName=d,o.status="stories.in-story";else if(c&&["block_quote","item","code_block"].includes(h)&&"stories.in-story"===o.status){var p=void 0;switch(h){case"block_quote":p=z.query;break;case"item":p=z.action;break;case"code_block":p=z.data}switch(p<=o.stateStep&&(void 0!==o.currentState&&(o.story.push(o.currentState),p===z.query&&"LUS"!==o.currentState.action&&o.story.push({query:"",action:"LUS"})),o.currentState={query:"",action:"LUS"}),p){case z.query:o.status="stories.new-query";break;case z.action:o.status="stories.new-action";break;case z.data:"json"===v&&(o.currentState.data=JSON.parse(d))}o.stateStep=p}else"text"===h&&"stories.new-query"===o.status?o.currentState.query+=d:c&&"link"===h&&"stories.new-query"===o.status?(o.slot=f,o.status="stories.new-slot"):"text"===h&&"stories.new-slot"===o.status?(o.extractedValues.push({extract:d,start:o.currentState.query.length,end:o.currentState.query.length+d.length-1}),o.currentState.query+=d,o.status="stories.new-query"):c||"block_quote"!==h||"stories.new-query"!==o.status?"text"===h&&"stories.new-action"===o.status&&(o.currentState.action=d,o.status="stories.in-story"):(o.extractedValues.length>0&&u(o.currentState.query),o.status="stories.in-story");r=e.next()}return a(),s},trainTestSplit:function(t,e){for(var n=[],r=0;r/t.length<e;r+=1)n.push.apply(n,t.splice(Math.floor(Math.random()*t.length),1));return{train:t,test:n}},NLUFormatter:function(){function t(t){var e=t.slots,n=void 0===e?[]:e,r=t.LUSAction,i=void 0===r?"LUS":r;this.model=t.model,this.slots=n,this.LUSAction=i}var e=t.prototype;return e.ask=function(t){try{var e=this,n={query:t,actions:[],turnConfidence:1,slots:{}};return Promise.resolve(e.model.predict(t)).then(function(t){var r=t.action,i=t.confidence;function o(){return e.slots.forEach(function(t){n.slots[t.id]=t.getValue()}),n}var s=function(t,e,n){for(var r;;){var i=t();if(w(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=n();if(o&&o.then){if(!w(o)){r=1;break}o=o.s}}var s=new x,a=b.bind(null,s,2);return(0===r?i.then(c):1===r?o.then(u):(void 0).then(function(){(i=t())?i.then?i.then(c).then(void 0,a):c(i):b(s,1,o)})).then(void 0,a),s;function u(e){o=e;do{if(!(i=t())||w(i)&&!i.v)return void b(s,1,o);if(i.then)return void i.then(c).then(void 0,a);w(o=n())&&(o=o.v)}while(!o||!o.then);o.then(u).then(void 0,a)}function c(t){t?(o=n())&&o.then?o.then(u).then(void 0,a):u(o):b(s,1,o)}}(function(){return r!==e.LUSAction},0,function(){return n.actions.push(r),n.turnConfidence*=i,Promise.resolve(e.model.predict("")).then(function(t){r=t.action,i=t.confidence})});return s&&s.then?s.then(o):o()})}catch(t){return Promise.reject(t)}},e.resetDialog=function(){this.model.resetDialog()},t}(),KeyedVectors:function(){function e(t){var e=t.loaderFunction,n=t.size,r=t.tokenization,i=void 0===r?"word":r,o=t.cased,s=void 0!==o&&o,a=t.maxDistance,u=void 0===a?.5:a,c=t.unknownKey,l=void 0===c?void 0:c;if(!["word","byte_pair"].includes(i))throw new Error('KeyedVector tokenization setting must be "word" or "byte_pair"');this.loaderFunction=e,this.size=n,this.tokenization=i,this.cased=s,this.maxDistance=u,this.unknownKey=l}var n=e.prototype;return n.keys=function(){return Object.keys(this.vectors)},n.load=function(){try{var t=this;return Promise.resolve(t.loaderFunction()).then(function(e){t.vectors=JSON.parse(e),"byte_pair"===t.tokenization&&(t.trie=new d,t.keys().forEach(function(e){return t.trie.add(e)}))})}catch(t){return Promise.reject(t)}},n.isLoaded=function(){return void 0!==this.vectors},n.get=function(e){if(this.keys().includes(e))return t.tensor1d(this.vectors[e]);var n,r=Infinity;return this.keys().forEach(function(t){var i=s(t,e);i<r&&(n=t,r=i)}),r<=this.maxDistance?t.tensor(this.vectors[n]):void 0!==this.unknownKey?t.tensor(this.vectors[this.unknownKey]):void 0},n.wordTokenize=function(t){return t.split(/\W/g).filter(function(t){return t.length>0})},n.bytePairTokenize=function(t){var e=(" "+t).split(" ").join("▁");return this.trie.split(e,this.unknownKey,["▁"])},n.tokenize=function(t){switch(this.cased&&(t=t.toLowerCase()),this.tokenization){case"word":return this.wordTokenize(t);case"byte_pair":return this.bytePairTokenize(t);default:throw new Error('KeyedVector tokenization setting must be "word" or "byte_pair"')}},e}()};exports.featurizers=v,exports.models=S,exports.slots=P,exports.tools=A,exports.utils=f;
//# sourceMappingURL=index.js.map
