import*as t from"@tensorflow/tfjs";import{zeros as e,tidy as n,initializers as r,basicLSTMCell as i,stack as o,dropout as s,sum as a,tensor as u,oneHot as c,dispose as l,concat as h,mul as f,ones as d,metrics as v,keep as m,math as p,eye as y,train as g,tensor1d as z}from"@tensorflow/tfjs";import{load as S}from"@tensorflow-models/universal-sentence-encoder";import{Parser as b}from"commonmark";var P=function(){function t(){this.size=1}var n=t.prototype;return n.init=function(t){try{return this.actions=t,Promise.resolve()}catch(t){return Promise.reject(t)}},n.handleQuery=function(t){return Promise.resolve()},n.getOptimizableFeatures=function(t){return void 0===t?e([1]):t},n.handleAction=function(t){},n.getActionMask=function(){return this.actions.map(function(){return!0})},n.resetDialog=function(){},n.load=function(t){},n.export=function(){return Promise.resolve({})},t}();function k(){return(k=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function w(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function x(t,e){for(var n=Array.from(Array(t.length+1),function(){return new Array(e.length+1).fill(0)}),r=1;r<=t.length;r+=1)n[r][0]=r;for(var i=1;i<=e.length;i+=1)n[0][i]=i;for(var o=0;o<e.length;o+=1)for(var s=0;s<t.length;s+=1)n[s+1][o+1]=Math.min(n[s][o+1]+1,n[s+1][o]+1,n[s][o]+(t[s]!==e[o]?1:0));return n[t.length][e.length]/Math.max(t.length,e.length,1)}function A(t,e){for(var n={extract:void 0,score:0},r=0;r<t.length;r+=1){var i=t.substring(r,r+e.length),o={extract:i,score:1-x(i,e)};if(1===o.score)return o;o.score>n.score&&(n=o)}return n}function j(t){for(var e=0,n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}function _(t,e,i){return void 0===e&&(e=!1),void 0===i&&(i="he"),n(function(){var n;switch(i){case"he":n=r.heNormal({});break;case"zeros":n=r.zeros();break;case"normal":n=r.randomNormal({});break;default:throw new Error("Expected parameter init to take value 'he', 'zeros' or 'normal' not '"+i+"'.")}var o=n.apply(t);return e&&(o=o.asScalar()),o.variable()})}var L=function(){function t(t,e,n,r){void 0===r&&(r=.2),this.lstmKernel=_([t+e,4*e]),this.lstmBias=_([4*e],!1,"zeros"),this.lstmForgetBias=_([1],!0,"zeros"),this.lstmInitH=_([1,e]),this.lstmInitC=_([1,e]),this.denseWeights=_([e,n]),this.denseBias=_([n],!1,"zeros"),this.dropout=r}var e=t.prototype;return e.initLSTM=function(t){return void 0===t&&(t=!0),{c:t?this.lstmInitC.clone():this.lstmInitC,h:t?this.lstmInitH.clone():this.lstmInitH}},e.predict=function(t,e,r,u,c){var l=this;return void 0===c&&(c=1),n(function(){var n=i(l.lstmForgetBias,l.lstmKernel,l.lstmBias,o([t]),r,e),h=n[0],f=n[1],d=s(f,l.dropout).matMul(l.denseWeights).add(l.denseBias).squeeze().div(c).softmax().mul(null!=u?u:1);return{y:d=d.div(a(d)),nc:h,nh:f}})},e.load=function(t){var e=this;n(function(){e.lstmKernel=u(t.lstmKernel).variable(),e.lstmBias=u(t.lstmBias).variable(),e.lstmForgetBias=u(t.lstmForgetBias).variable(),e.lstmInitH=u(t.lstmInitH).variable(),e.lstmInitC=u(t.lstmInitC).variable(),e.denseWeights=u(t.denseWeights).variable(),e.denseBias=u(t.denseBias).variable()})},e.export=function(){try{var t=this;return Promise.resolve(t.lstmKernel.array()).then(function(e){return Promise.resolve(t.lstmBias.array()).then(function(n){return Promise.resolve(t.lstmForgetBias.array()).then(function(r){return Promise.resolve(t.lstmInitH.array()).then(function(i){return Promise.resolve(t.lstmInitC.array()).then(function(o){return Promise.resolve(t.denseWeights.array()).then(function(s){return Promise.resolve(t.denseBias.array()).then(function(t){return{lstmKernel:e,lstmBias:n,lstmForgetBias:r,lstmInitH:i,lstmInitC:o,denseWeights:s,denseBias:t}})})})})})})})}catch(t){return Promise.reject(t)}},t}(),O=function(){function t(t,e){this.key=t,this.parent=e,this.childs={},this.ending=!1}var e=t.prototype;return e.addChild=function(t){this.childs[t.key]=t},e.setEnding=function(){this.ending=!0},t}(),V=function(){function t(){this.root=new O("",null)}var e=t.prototype;return e.add=function(t){for(var e=this.root,n=0;n<t.length;n+=1)void 0===e.childs[t[n]]&&e.addChild(new O(t[n],e)),e=e.childs[t[n]],n===t.length-1&&e.setEnding()},e.split=function(t,e,n){void 0===e&&(e=void 0),void 0===n&&(n=[]);var r=[];function i(t){r[r.length-1]===e||n.includes(t)||r.push(e)}for(var o=this.root,s="",a=0;a<t.length;a+=1){var u=t[a];void 0!==o.childs[u]?(s+=u,o=o.childs[u]):(o.ending?r.push(s):i(s),void 0!==this.root.childs[u]?(s=u,o=this.root.childs[u]):(i(s),s="",o=this.root))}return o.ending?r.push(s):i(s),r},t}(),q={__proto__:null,fuzzyMatch:A,hashcode:j,initializeVariable:_,levenshteinDistance:x,LSTM:L,Trie:V},C={__proto__:null,Featurizer:P,ActionFeaturizer:function(t){function e(e){var n,r=void 0===e?{maskLUS:!0,maskPreviousAction:!0,LUSAction:"LUS"}:e,i=r.maskLUS,o=void 0===i||i,s=r.maskPreviousAction,a=void 0===s||s,u=r.LUSAction,c=void 0===u?"LUS":u;return(n=t.call(this)||this).id="Action Featurizer",n.maskLUS=o,n.maskPreviousAction=a,n.LUSAction=c,n.resetDialog(),n}w(e,t);var r=e.prototype;return r.init=function(e){try{var n=this;return Promise.resolve(t.prototype.init.call(n,e)).then(function(){n.size=e.length,n.embeddings=_([n.size,n.size])})}catch(t){return Promise.reject(t)}},r.handleQuery=function(t){try{var e=this;return Promise.resolve(n(function(){return e.userTalked=""!==t,c([e.actions.indexOf(e.previousAction)],e.actions.length)}))}catch(t){return Promise.reject(t)}},r.getOptimizableFeatures=function(t){return t.matMul(this.embeddings).squeeze()},r.handleAction=function(t){this.previousAction=t!==this.LUSAction?t:this.previousAction},r.getActionMask=function(){var e=t.prototype.getActionMask.call(this);return this.maskLUS&&this.userTalked&&(e[this.actions.indexOf(this.LUSAction)]=!1),this.maskPreviousAction&&this.actions.includes(this.previousAction)&&(e[this.actions.indexOf(this.previousAction)]=!1),e},r.resetDialog=function(){this.userTalked=!1,this.previousAction=void 0},r.load=function(t){this.embeddings=n(function(){return u(t.embeddings).variable()})},r.export=function(){try{return Promise.resolve(this.embeddings.array()).then(function(t){return{embeddings:t}})}catch(t){return Promise.reject(t)}},e}(P),BOW:function(t){function e(e){var n;return(n=t.call(this)||this).id="Bag-of-Words",n.size=e,n}return w(e,t),e.prototype.handleQuery=function(t){try{var e=this;return Promise.resolve(n(function(){var n=t.toLowerCase().split(/\W/g).map(function(t){return j(t)%e.size});return c(n,e.size).asType("float32").sum(0)}))}catch(t){return Promise.reject(t)}},e}(P),USE:function(t){function e(){var e;return(e=t.apply(this,arguments)||this).id="Universal Sentence Encoder",e.size=512,e}w(e,t);var n=e.prototype;return n.init=function(e){try{var n=this;return Promise.resolve(t.prototype.init.call(n,e)).then(function(){return Promise.resolve(S()).then(function(t){return n.encoder=t,Promise.resolve(n.encodeQuery("")).then(function(t){n.emptyEncoding=t})})})}catch(t){return Promise.reject(t)}},n.encodeQuery=function(t){try{return Promise.resolve(this.encoder.embed([t])).then(function(t){var e=t.squeeze();return l(t),e})}catch(t){return Promise.reject(t)}},n.handleQuery=function(t){try{return Promise.resolve(t?this.encodeQuery(t):this.emptyEncoding.clone())}catch(t){return Promise.reject(t)}},e}(P),WordEmbedding:function(t){function r(e){var n;return(n=t.call(this)||this).id="Word Embedding",n.size=2*e.size,n.vectors=e,n}w(r,t);var i=r.prototype;return i.init=function(e){try{var n=this;return Promise.resolve(t.prototype.init.call(n,e)).then(function(){var t=function(){if(!n.vectors.isLoaded())return Promise.resolve(n.vectors.load()).then(function(){})}();if(t&&t.then)return t.then(function(){})})}catch(t){return Promise.reject(t)}},i.handleQuery=function(t){try{var r=this;return Promise.resolve(n(function(){var n=r.vectors.tokenize(t).map(function(t){return r.vectors.get(t)}).filter(function(t){return void 0!==t});if(0===n.length)return e([r.size]);var i=o(n);return h([i.mean(0),i.max(0)])}))}catch(t){return Promise.reject(t)}},r}(P)};function D(t,e,n){if(!t.s){if(n instanceof M){if(!n.s)return void(n.o=D.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(D.bind(null,t,e),D.bind(null,t,2));t.s=e,t.v=n;var r=t.o;r&&r(t)}}var M=function(){function t(){}return t.prototype.then=function(e,n){var r=new t,i=this.s;if(i){var o=1&i?e:n;if(o){try{D(r,1,o(this.v))}catch(t){D(r,2,t)}return r}return this}return this.o=function(t){try{var i=t.v;1&t.s?D(r,1,e?e(i):i):n?D(r,1,n(i)):D(r,2,i)}catch(t){D(r,2,t)}},r},t}();function E(t){return t instanceof M&&1&t.s}function U(t,e,n){for(var r;;){var i=t();if(E(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=n();if(o&&o.then){if(!E(o)){r=1;break}o=o.s}if(e){var s=e();if(s&&s.then&&!E(s)){r=2;break}}}var a=new M,u=D.bind(null,a,2);return(0===r?i.then(l):1===r?o.then(c):s.then(h)).then(void 0,u),a;function c(r){o=r;do{if(e&&(s=e())&&s.then&&!E(s))return void s.then(h).then(void 0,u);if(!(i=t())||E(i)&&!i.v)return void D(a,1,o);if(i.then)return void i.then(l).then(void 0,u);E(o=n())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,u)}function l(t){t?(o=n())&&o.then?o.then(c).then(void 0,u):c(o):D(a,1,o)}function h(){(i=t())?i.then?i.then(l).then(void 0,u):l(i):D(a,1,o)}}var F,B={__proto__:null,HCN:function(){function r(t){var e=t.actions,n=t.featurizers,r=t.hiddenSize,i=void 0===r?32:r,o=t.optimizer,s=void 0===o?g.adam(.01):o,a=t.temperature,u=void 0===a?1:a,c=t.dropout,l=void 0===c?0:c;this.actions=e,this.featurizers=n,this.optimizer=s,this.hiddenSize=i,this.outputSize=e.length,this.lstmTemperature=u,this.lstmDropout=l}var i=r.prototype;return i.init=function(){try{var t=this;return Promise.resolve(Promise.all(t.featurizers.map(function(e){return e.init(t.actions)}))).then(function(){t.inputSize=t.featurizers.map(function(t){return t.size}).reduce(function(t,e){return t+e},1),t.lstm=new L(t.inputSize,t.hiddenSize,t.outputSize,t.lstmDropout),t.resetDialog()})}catch(t){return Promise.reject(t)}},i.resetDialog=function(){this.featurizers.forEach(function(t){return t.resetDialog()});var t=this.lstm.initLSTM();this.lstmC=t.c,this.lstmH=t.h},i.handleQuery=function(t){try{return Promise.all(this.featurizers.map(function(e){return e.handleQuery(t)}))}catch(t){return Promise.reject(t)}},i.getOptimizableFeatures=function(t){var r=this;return n(function(){var n=r.featurizers.map(function(e,n){return e.getOptimizableFeatures(t[n])});return n.push(e([1])),h(n)})},i.handleAction=function(t){this.featurizers.map(function(e){return e.handleAction(t)})},i.getActionMask=function(){var t=this;return n(function(){return t.featurizers.map(function(t){return u(t.getActionMask(),void 0,"float32")}).reduce(function(t,e){return f(t,e)},d([t.actions.length]))})},i.fitStory=function(t){try{var e=function(){var t;return n.optimizer.minimize(function(){var e=n.lstm.initLSTM(!1),a=e.c,u=e.h,c=r.map(function(t,e){var r=n.lstm.predict(n.getOptimizableFeatures(t),a,u,i[e]);return a=r.nc,u=r.nh,r.y}),l=o(s),h=o(c),f=v.categoricalCrossentropy(l,h).mean();return t={targets:m(l.argMax(1)),predictions:m(h.argMax(1)),loss:f.arraySync(),isFailing:v.categoricalAccuracy(l,h).mean().arraySync()<.999},f}),l([r,s]),t},n=this;n.resetDialog();var r=[],i=[],s=[],a=0,u=U(function(){return a<t.length},function(){return!!(a+=1)},function(){var e=t[a],o=r.push;return Promise.resolve(n.handleQuery(e.query)).then(function(t){o.call(r,t),i.push(n.getActionMask()),s.push(c(n.actions.indexOf(e.action),n.outputSize)),n.handleAction(e.action)})});return Promise.resolve(u&&u.then?u.then(e):e())}catch(t){return Promise.reject(t)}},i.train=function(e){var r=e.stories,i=e.nEpochs,o=void 0===i?12:i,s=e.onEpochEnd,a=void 0===s?void 0:s;try{var u,c=function(){return f.resetDialog(),u},f=this,d=Object.entries(r),v=0,m=U(function(){return v<o},function(){return!!(v+=1)},function(){function e(){var e=n(function(){return p.confusionMatrix(h(r),h(i),f.outputSize)}),c=n(function(){return e.mul(y.apply(t,e.shape)).sum(0)});u={epoch:v,failingSamples:s,accuracy:n(function(){return c.sum().div(e.sum()).arraySync()}),recall:n(function(){return c.div(e.sum(1)).mean().arraySync()}),precision:n(function(){return c.div(e.sum(0)).mean().arraySync()}),loss:o.reduce(function(t,e){return t+e})/o.length},l(r),l(i),l([c,e]),void 0!==a&&a(u)}var r=[],i=[],o=[],s=[],c=0,m=U(function(){return c<d.length},function(){return!!(c+=1)},function(){var t=d[c],e=t[0];return Promise.resolve(f.fitStory(t[1])).then(function(t){r.push(t.targets),i.push(t.predictions),o.push(t.loss),t.isFailing&&s.push(e)})});return m&&m.then?m.then(e):e()});return Promise.resolve(m&&m.then?m.then(c):c())}catch(t){return Promise.reject(t)}},i.predict=function(t){try{var e=this;e.lstm.dropout=0;var r=e.getOptimizableFeatures;return Promise.resolve(e.handleQuery(t)).then(function(t){var i=r.call(e,t),o=e.getActionMask(),s=e.lstm.predict(i,e.lstmC,e.lstmH,o,e.lstmTemperature);l([e.lstmC,e.lstmH]),e.lstmC=s.nc.clone(),e.lstmH=s.nh.clone();var a=n(function(){return s.y.argMax().arraySync()}),u=n(function(){return s.y.arraySync()[a]});return l([i,o]),l(s),e.lstm.dropout=e.lstmDropout,e.handleAction(e.actions[a]),{action:e.actions[a],confidence:u}})}catch(t){return Promise.reject(t)}},i.score=function(e){try{var r=function(){var e=n(function(){return p.confusionMatrix(u(s),u(a),i.outputSize)}),r=n(function(){return e.mul(y.apply(t,e.shape)).sum(0)}),o={failingSamples:h,accuracy:n(function(){return r.sum().div(e.sum()).arraySync()}),recall:n(function(){return r.div(e.sum(1)).mean().arraySync()}),precision:n(function(){return r.div(e.sum(0)).mean().arraySync()}),averageConfidence:c.reduce(function(t,e){return t+e})/c.length};return l([r,e]),i.resetDialog(),o},i=this,o=Object.entries(e),s=[],a=[],c=[],h=[],f=0,d=U(function(){return f<o.length},function(){return!!(f+=1)},function(){var t=o[f],e=t[0],n=t[1];i.resetDialog();var r=0,u=U(function(){return r<n.length},function(){return!!(r+=1)},function(){var t=n[r];return Promise.resolve(i.predict(t.query)).then(function(n){var r=n.action,o=n.confidence;s.push(i.actions.indexOf(t.action)),a.push(i.actions.indexOf(r)),c.push(o),r===t.action||h.includes(e)||h.push(e)})});if(u&&u.then)return u.then(function(){})});return Promise.resolve(d&&d.then?d.then(r):r())}catch(t){return Promise.reject(t)}},i.load=function(t){var e=JSON.parse(t);this.featurizers.forEach(function(t){t.load(e[t.id])}),this.lstm.load(e.lstm),this.resetDialog()},i.export=function(){try{var t=this;return Promise.resolve(t.lstm.export()).then(function(e){function n(){return JSON.stringify(r)}var r={lstm:e},i=0,o=U(function(){return i<t.featurizers.length},function(){return!!(i+=1)},function(){var e=t.featurizers[i];return Promise.resolve(e.export()).then(function(t){r[e.id]=t})});return o&&o.then?o.then(n):n()})}catch(t){return Promise.reject(t)}},r}()},T=function(t){function e(e,n){var r;return(r=t.call(this)||this).dependantActions=e,r.invDependantActions=n,r}w(e,t);var n=e.prototype;return n.getActionMask=function(){var t=this;return this.actions.map(function(e){var n=void 0!==t.value,r=t.dependantActions.includes(e),i=t.invDependantActions.includes(e);return!n&&(!r||i)||n&&!i})},n.resetDialog=function(){this.value=void 0},n.getValue=function(){return this.value},n.setValue=function(t){this.value=t},e}(P),H={__proto__:null,Slot:T,CategoricalSlot:function(t){function e(e){var n,r=e.name,i=e.categories,o=e.dependantActions,s=e.invDependantActions,a=e.threshold,u=void 0===a?.75:a;return(n=t.call(this,void 0===o?[]:o,void 0===s?[]:s)||this).categoryNames=Object.keys(i),n.categories=i,n.threshold=u,n.id=r+"#Categorical",n.size=2*n.categoryNames.length,n}w(e,t);var r=e.prototype;return r.init=function(e){try{var n=this;return Promise.resolve(t.prototype.init.call(n,e)).then(function(){n.resetDialog()})}catch(t){return Promise.reject(t)}},r.oneHotValue=function(t){var e=Object.keys(this.categories);return c(e.indexOf(t.category),e.length)},r.handleQuery=function(t){try{var e=this,r=e.getValue(),i={category:void 0,extract:void 0,score:0};Object.entries(e.categories).forEach(function(n){var o=n[0],s=n[1].map(function(e){return A(t.toLowerCase(),e.toLowerCase())}).filter(function(t){return t.score>=e.threshold}).reduce(function(t,e){return t.score>e.score?t:e},{extract:void 0,score:0});if(void 0!==s.extract){var a=o!==r.category,u=i.category===r.category,c=s.score>i.score;(void 0===i.category||a&&c||u&&a||u&&c)&&(i=k({category:o},s))}});var o=n(function(){return h([e.oneHotValue(i),e.oneHotValue(e.getValue())])});return void 0!==i.category&&e.setValue(i),Promise.resolve(o)}catch(t){return Promise.reject(t)}},r.getValue=function(){return void 0===t.prototype.getValue.call(this)?{category:void 0,extract:void 0,score:0}:t.prototype.getValue.call(this)},e}(T)};function I(t,e,n){if(!t.s){if(n instanceof N){if(!n.s)return void(n.o=I.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(I.bind(null,t,e),I.bind(null,t,2));t.s=e,t.v=n;var r=t.o;r&&r(t)}}!function(t){t[t.query=0]="query",t[t.data=1]="data",t[t.action=2]="action",t[t.empty=3]="empty"}(F||(F={}));var N=function(){function t(){}return t.prototype.then=function(e,n){var r=new t,i=this.s;if(i){var o=1&i?e:n;if(o){try{I(r,1,o(this.v))}catch(t){I(r,2,t)}return r}return this}return this.o=function(t){try{var i=t.v;1&t.s?I(r,1,e?e(i):i):n?I(r,1,n(i)):I(r,2,i)}catch(t){I(r,2,t)}},r},t}();function K(t){return t instanceof N&&1&t.s}var Q={__proto__:null,parseWistyML:function(t){var e=new b({smart:!0}).parse(t).walker(),n=e.next(),r={section:void 0,status:void 0,slot:void 0,sentence:"",extractedValues:[],storyName:void 0,story:[],currentState:void 0,stateStep:F.empty},i={stories:{},extractedValues:{}};function o(){void 0!==r.storyName&&(r.story.push(r.currentState),r.story.push({query:"",action:"LUS"}),i.stories[r.storyName]=r.story,r.storyName=void 0,r.story=[],r.currentState=void 0,r.stateStep=F.empty)}function s(t){var e;void 0===i.extractedValues[r.slot]&&(i.extractedValues[r.slot]=[]),(e=i.extractedValues[r.slot]).push.apply(e,r.extractedValues.map(function(e){return k({sentence:t},e)})),r.extractedValues=[],r.sentence=""}for(;null!==n;){var a=n.entering,u=n.node,c=u.type,l=u.literal,h=u.destination,f=u.info,d=u.level;if(a&&"heading"===c&&2===d)r.status="new-section",o();else if("text"===c&&"new-section"===r.status)r.section=l,r.status=l+".entering";else if("wisty.slots"===r.section)a&&"heading"===c&&3===d?r.status="slots.new-slot":"text"===c&&"slots.new-slot"===r.status?(l in i.extractedValues||(i.extractedValues[l]=[]),r.slot=l,r.status="slots.in-slot"):a&&"item"===c&&"slots.in-slot"===r.status?r.status="slots.in-sample":"text"===c&&"slots.in-sample"===r.status?r.sentence+=l:"code"===c&&"slots.in-sample"===r.status?(r.extractedValues.push({extract:l,start:r.sentence.length,end:r.sentence.length+l.length-1}),r.sentence+=l):a||"item"!==c||"slots.in-sample"!==r.status||(s(r.sentence),r.status="slots.in-slot");else if("wisty.stories"===r.section)if(a&&"heading"===c&&3===d)r.status="stories.new-story",o();else if("text"===c&&"stories.new-story"===r.status)r.storyName=l,r.status="stories.in-story";else if(a&&["block_quote","item","code_block"].includes(c)&&"stories.in-story"===r.status){var v=void 0;switch(c){case"block_quote":v=F.query;break;case"item":v=F.action;break;case"code_block":v=F.data}switch(v<=r.stateStep&&(void 0!==r.currentState&&(r.story.push(r.currentState),v===F.query&&"LUS"!==r.currentState.action&&r.story.push({query:"",action:"LUS"})),r.currentState={query:"",action:"LUS"}),v){case F.query:r.status="stories.new-query";break;case F.action:r.status="stories.new-action";break;case F.data:"json"===f&&(r.currentState.data=JSON.parse(l))}r.stateStep=v}else"text"===c&&"stories.new-query"===r.status?r.currentState.query+=l:a&&"link"===c&&"stories.new-query"===r.status?(r.slot=h,r.status="stories.new-slot"):"text"===c&&"stories.new-slot"===r.status?(r.extractedValues.push({extract:l,start:r.currentState.query.length,end:r.currentState.query.length+l.length-1}),r.currentState.query+=l,r.status="stories.new-query"):a||"block_quote"!==c||"stories.new-query"!==r.status?"text"===c&&"stories.new-action"===r.status&&(r.currentState.action=l,r.status="stories.in-story"):(r.extractedValues.length>0&&s(r.currentState.query),r.status="stories.in-story");n=e.next()}return o(),i},trainTestSplit:function(t,e){for(var n=Object.entries(t),r=[],i=0;i/n.length<e;i+=1)r.push.apply(r,n.splice(Math.floor(Math.random()*n.length),1));return{train:Object.fromEntries(n),test:Object.fromEntries(r)}},NLUFormatter:function(){function t(t){var e=t.slots,n=void 0===e?[]:e,r=t.LUSAction,i=void 0===r?"LUS":r;this.model=t.model,this.slots=n,this.LUSAction=i}var e=t.prototype;return e.ask=function(t){try{var e=this,n={query:t,actions:[],turnConfidence:1,slots:{}};return Promise.resolve(e.model.predict(t)).then(function(t){var r=t.action,i=t.confidence;function o(){return e.slots.forEach(function(t){n.slots[t.id]=t.getValue()}),n}var s=function(t,e,n){for(var r;;){var i=t();if(K(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=n();if(o&&o.then){if(!K(o)){r=1;break}o=o.s}}var s=new N,a=I.bind(null,s,2);return(0===r?i.then(c):1===r?o.then(u):(void 0).then(function(){(i=t())?i.then?i.then(c).then(void 0,a):c(i):I(s,1,o)})).then(void 0,a),s;function u(e){o=e;do{if(!(i=t())||K(i)&&!i.v)return void I(s,1,o);if(i.then)return void i.then(c).then(void 0,a);K(o=n())&&(o=o.v)}while(!o||!o.then);o.then(u).then(void 0,a)}function c(t){t?(o=n())&&o.then?o.then(u).then(void 0,a):u(o):I(s,1,o)}}(function(){return r!==e.LUSAction},0,function(){return n.actions.push(r),n.turnConfidence*=i,Promise.resolve(e.model.predict("")).then(function(t){r=t.action,i=t.confidence})});return s&&s.then?s.then(o):o()})}catch(t){return Promise.reject(t)}},e.resetDialog=function(){this.model.resetDialog()},t}(),KeyedVectors:function(){function t(t){var e=t.loaderFunction,n=t.size,r=t.tokenization,i=void 0===r?"word":r,o=t.cased,s=void 0!==o&&o,a=t.maxDistance,u=void 0===a?.5:a,c=t.unknownKey,l=void 0===c?void 0:c;if(!["word","byte_pair"].includes(i))throw new Error('KeyedVector tokenization setting must be "word" or "byte_pair"');this.loaderFunction=e,this.size=n,this.tokenization=i,this.cased=s,this.maxDistance=u,this.unknownKey=l}var e=t.prototype;return e.keys=function(){return Object.keys(this.vectors)},e.load=function(){try{var t=this;return Promise.resolve(t.loaderFunction()).then(function(e){t.vectors=JSON.parse(e),"byte_pair"===t.tokenization&&(t.trie=new V,t.keys().forEach(function(e){return t.trie.add(e)}))})}catch(t){return Promise.reject(t)}},e.isLoaded=function(){return void 0!==this.vectors},e.get=function(t){if(this.keys().includes(t))return z(this.vectors[t]);var e,n=Infinity;return this.keys().forEach(function(r){var i=x(r,t);i<n&&(e=r,n=i)}),n<=this.maxDistance?u(this.vectors[e]):void 0!==this.unknownKey?u(this.vectors[this.unknownKey]):void 0},e.wordTokenize=function(t){return t.split(/\W/g).filter(function(t){return t.length>0})},e.bytePairTokenize=function(t){var e=(" "+t).split(" ").join("▁");return this.trie.split(e,this.unknownKey,["▁"])},e.tokenize=function(t){switch(this.cased&&(t=t.toLowerCase()),this.tokenization){case"word":return this.wordTokenize(t);case"byte_pair":return this.bytePairTokenize(t);default:throw new Error('KeyedVector tokenization setting must be "word" or "byte_pair"')}},t}()};export{C as featurizers,B as models,H as slots,Q as tools,q as utils};
//# sourceMappingURL=index.esm.js.map
