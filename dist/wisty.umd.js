!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@tensorflow-models/universal-sentence-encoder"),require("@tensorflow/tfjs")):"function"==typeof define&&define.amd?define(["exports","@tensorflow-models/universal-sentence-encoder","@tensorflow/tfjs"],e):e(t.wisty={},t.use,t.tf)}(this,function(t,e,n){var r=function t(e,r,i,o){void 0===o&&(o=n.train.adam()),this.lstmKernel=t.randomVariable([e+r,4*r]),this.lstmBias=t.randomVariable([4*r]),this.lstmForgetBias=t.randomVariable([1],!0),this.lstmInitH=t.randomVariable([1,r]),this.lstmInitC=t.randomVariable([1,r]),this.denseWeights=t.randomVariable([r,i]),this.denseBias=t.randomVariable([i]),this.optimizer=o};r.randomVariable=function(t,e){return void 0===e&&(e=!1),n.tidy(function(){var r=n.randomNormal(t);return e&&(r=r.asScalar()),r.variable()})},r.prototype.initLSTM=function(){return{c:this.lstmInitC.clone(),h:this.lstmInitH.clone()}},r.prototype.predict=function(t,e,r){var i=this;return n.tidy(function(){var o=n.basicLSTMCell(i.lstmForgetBias,i.lstmKernel,i.lstmBias,n.stack([t]),r,e),s=o[0],a=o[1];return{y:n.dropout(a,.2).matMul(i.denseWeights).add(i.denseBias).squeeze(),nc:s,nh:a}})},r.prototype.fitSequence=function(t,e){var r,i,o=this;return this.optimizer.minimize(function(){var s=o.lstmInitC,a=o.lstmInitH,c=n.stack(t.unstack().map(function(t){var e=o.predict(t,s,a);return s=e.nc,a=e.nh,e.y})),u=n.losses.softmaxCrossEntropy(e,c);return r=u.arraySync(),i=n.metrics.categoricalAccuracy(e,c).mean().arraySync(),u}),{loss:r,accuracy:i}},r.prototype.setWeights=function(t){var e=this;Object.entries(t).forEach(function(t){var n=t[1];switch(t[0]){case"lstmKernel":e.lstmKernel=n;break;case"lstmBias":e.lstmBias=n;break;case"lstmForgetBias":e.lstmForgetBias=n;break;case"lstmInitH":e.lstmInitH=n;break;case"lstmInitC":e.lstmInitC=n;break;case"denseWeights":e.denseWeights=n;break;case"denseBias":e.denseBias=n}})},r.prototype.getWeights=function(){return{lstmKernel:this.lstmKernel.clone(),lstmBias:this.lstmBias.clone(),lstmForgetBias:this.lstmForgetBias.clone(),lstmInitH:this.lstmInitH.clone(),lstmInitC:this.lstmInitC.clone(),denseWeights:this.denseWeights.clone(),denseBias:this.denseBias.clone()}};const i=function(){function t(){}return t.prototype.then=function(e,n){const r=new t,i=this.s;if(i){const t=1&i?e:n;if(t){try{o(r,1,t(this.v))}catch(t){o(r,2,t)}return r}return this}return this.o=function(t){try{const i=t.v;1&t.s?o(r,1,e?e(i):i):n?o(r,1,n(i)):o(r,2,i)}catch(t){o(r,2,t)}},r},t}();function o(t,e,n){if(!t.s){if(n instanceof i){if(!n.s)return void(n.o=o.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(o.bind(null,t,e),o.bind(null,t,2));t.s=e,t.v=n;const r=t.o;r&&r(t)}}function s(t){return t instanceof i&&1&t.s}function a(t,e,n){for(var r;;){var a=t();if(s(a)&&(a=a.v),!a)return c;if(a.then){r=0;break}var c=n();if(c&&c.then){if(!s(c)){r=1;break}c=c.s}if(e){var u=e();if(u&&u.then&&!s(u)){r=2;break}}}var h=new i,l=o.bind(null,h,2);return(0===r?a.then(m):1===r?c.then(f):u.then(d)).then(void 0,l),h;function f(r){c=r;do{if(e&&(u=e())&&u.then&&!s(u))return void u.then(d).then(void 0,l);if(!(a=t())||s(a)&&!a.v)return void o(h,1,c);if(a.then)return void a.then(m).then(void 0,l);s(c=n())&&(c=c.v)}while(!c||!c.then);c.then(f).then(void 0,l)}function m(t){t?(c=n())&&c.then?c.then(f).then(void 0,l):f(c):o(h,1,c)}function d(){(a=t())?a.then?a.then(m).then(void 0,l):m(a):o(h,1,c)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var c=function(t,e,i,o){void 0===i&&(i=128),void 0===o&&(o=n.train.adam(.01)),this.actions=t,this.featurizers=e,this.inputSize=e.map(function(t){return t.size}).reduce(function(t,e){return t+e},1),this.outputSize=t.length,this.lstm=new r(this.inputSize,i,this.outputSize,o),this.resetDialog()};c.prototype.resetDialog=function(){var t;this.featurizers.forEach(function(t){return t.resetDialog()}),t=this.lstm.initLSTM(),this.lstmC=t.c,this.lstmH=t.h},c.prototype.featurize=function(t){try{return Promise.resolve(Promise.all(this.featurizers.map(function(e){return e.handleQuery(t)}))).then(function(t){t.push(n.zeros([1]));var e=n.concat(t);return n.dispose(t),e})}catch(t){return Promise.reject(t)}},c.prototype.fitStory=function(t,e){try{var r=this;function i(){var t=Object.assign({},{epoch:e},n.tidy(function(){return r.lstm.fitSequence(n.stack(o),n.stack(s))}));return n.dispose([o,s]),t}r.resetDialog();var o=[],s=[],c=0,u=a(function(){return c<t.length},function(){return!!(c+=1)},function(){var e=t[c],i=o.push;return Promise.resolve(r.featurize(e.query)).then(function(t){i.call(o,t),s.push(n.oneHot(r.actions.indexOf(e.action),r.outputSize))})});return Promise.resolve(u&&u.then?u.then(i):i())}catch(t){return Promise.reject(t)}},c.prototype.train=function(t,e,n){void 0===e&&(e=12);try{var r=this;function i(){return r.resetDialog(),o}var o=[],s=0,c=a(function(){return s<e},function(){return!!(s+=1)},function(){var e=[];return t.forEach(function(t){e.push(r.fitStory(t,s))}),Promise.resolve(Promise.all(e)).then(function(t){e=t,void 0!==n&&n(e),o.push.apply(o,e)})});return Promise.resolve(c&&c.then?c.then(i):i())}catch(t){return Promise.reject(t)}},c.prototype.predict=function(t,e){void 0===e&&(e=10);try{var r=this;return Promise.resolve(r.featurize(t)).then(function(t){for(var i,o=[],s=0;s<e;s+=1)n.dispose(i),i=r.lstm.predict(t,r.lstmC,r.lstmH),o.push(i.y.softmax());n.dispose([r.lstmC,r.lstmH]),r.lstmC=i.nc.clone(),r.lstmH=i.nh.clone();var a=n.tidy(function(){return n.moments(n.stack(o),0)}),c=a.mean,u=a.variance,h=n.tidy(function(){return c.argMax().arraySync()}),l=1-n.tidy(function(){return u.sqrt().arraySync()[h]});return n.dispose([t,c,u]),n.dispose(i),n.dispose(o),{action:r.actions[h],confidence:l}})}catch(t){return Promise.reject(t)}},c.prototype.load=function(t){var e=this;n.tidy(function(){var r=JSON.parse(t);Object.entries(r).forEach(function(t){r[t[0]]=n.tensor(t[1]).variable()}),e.lstm.setWeights(r)})},c.prototype.export=function(){var t=this;return n.tidy(function(){var e={};return Object.entries(t.lstm.getWeights()).forEach(function(t){e[t[0]]=t[1].arraySync()}),JSON.stringify(e)})};var u=function(){this.size=512};u.prototype.init=function(){try{var t=this;return Promise.resolve(e.load()).then(function(e){return t.encoder=e,Promise.resolve(t.encodeQuery("")).then(function(e){t.emptyEncoding=e})})}catch(t){return Promise.reject(t)}},u.prototype.encodeQuery=function(t){try{return Promise.resolve(this.encoder.embed([t])).then(function(t){var e=t.squeeze();return n.dispose(t),e})}catch(t){return Promise.reject(t)}},u.prototype.handleQuery=function(t){try{return t?Promise.resolve(this.encodeQuery(t)):Promise.resolve(this.emptyEncoding.clone())}catch(t){return Promise.reject(t)}},u.prototype.resetDialog=function(){};var h=function(t){this.size=t};h.prototype.handleQuery=function(t){try{var e=this;return Promise.resolve(n.tidy(function(){var r=t.split(" ").map(function(t){return function(t){for(var e=0,n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}(t)%e.size});return n.oneHot(r,e.size).asType("float32").sum(0)}))}catch(t){return Promise.reject(t)}},h.prototype.resetDialog=function(){},t.LSTM=r,t.HCN=c,t.USE=u,t.BOW=h,t.loadStories=function(t){try{return Promise.resolve(fetch(t).then(function(t){return t.text()})).then(function(t){var e={query:void 0,action:void 0},n=[],r=[];return t.split("\n").forEach(function(t){var i=t.substring(2);t.startsWith("## ")?(n.length>0&&(void 0!==e.action&&(n.push(e),e={query:void 0,action:void 0}),r.push(n)),n=[]):t.startsWith("- ")?void 0===e.action?e.action=i:(n.push(e),e={query:"",action:i}):t.startsWith("> ")&&(void 0===e.query?e.query=i:void 0!==e.action?(n.push(e),n.push({query:"",action:"LUS"}),e={query:i,action:void 0}):e.query+=" "+i)}),void 0!==e.action&&n.push(e),n.push({query:"",action:"LUS"}),n&&r.push(n),r})}catch(t){return Promise.reject(t)}}});
//# sourceMappingURL=wisty.umd.js.map
