!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@tensorflow/tfjs"),require("@tensorflow-models/universal-sentence-encoder")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs","@tensorflow-models/universal-sentence-encoder"],e):e((t=t||self).wisty={},t.tf,t.use)}(this,function(t,e,n){function r(t,n,r){return void 0===n&&(n=!1),void 0===r&&(r="he"),e.tidy(function(){var i;switch(r){case"he":i=e.initializers.heNormal({});break;case"zeros":i=e.initializers.zeros();break;case"normal":i=e.initializers.randomNormal({});break;default:throw new Error("Expected parameter init to take value 'he', 'zeros' or 'normal' not '"+r+"'.")}var o=i.apply(t);return n&&(o=o.asScalar()),o.variable()})}var i=function(){function t(t,e,n,i){void 0===i&&(i=.2),this.lstmKernel=r([t+e,4*e]),this.lstmBias=r([4*e],!1,"zeros"),this.lstmForgetBias=r([1],!0,"zeros"),this.lstmInitH=r([1,e]),this.lstmInitC=r([1,e]),this.denseWeights=r([e,n]),this.denseBias=r([n],!1,"zeros"),this.dropout=i}var n=t.prototype;return n.initLSTM=function(t){return void 0===t&&(t=!0),{c:t?this.lstmInitC.clone():this.lstmInitC,h:t?this.lstmInitH.clone():this.lstmInitH}},n.predict=function(t,n,r,i,o){var s=this;return void 0===o&&(o=1),e.tidy(function(){var u=e.basicLSTMCell(s.lstmForgetBias,s.lstmKernel,s.lstmBias,e.stack([t]),r,n),a=u[0],c=u[1],l=e.dropout(c,s.dropout).matMul(s.denseWeights).add(s.denseBias).squeeze().div(o).softmax().mul(null!=i?i:1);return{y:l=l.div(e.sum(l)),nc:a,nh:c}})},n.load=function(t){var n=this;e.tidy(function(){n.lstmKernel=e.tensor(t.lstmKernel).variable(),n.lstmBias=e.tensor(t.lstmBias).variable(),n.lstmForgetBias=e.tensor(t.lstmForgetBias).variable(),n.lstmInitH=e.tensor(t.lstmInitH).variable(),n.lstmInitC=e.tensor(t.lstmInitC).variable(),n.denseWeights=e.tensor(t.denseWeights).variable(),n.denseBias=e.tensor(t.denseBias).variable()})},n.export=function(){try{var t=this;return Promise.resolve(t.lstmKernel.array()).then(function(e){return Promise.resolve(t.lstmBias.array()).then(function(n){return Promise.resolve(t.lstmForgetBias.array()).then(function(r){return Promise.resolve(t.lstmInitH.array()).then(function(i){return Promise.resolve(t.lstmInitC.array()).then(function(o){return Promise.resolve(t.denseWeights.array()).then(function(s){return Promise.resolve(t.denseBias.array()).then(function(t){return{lstmKernel:e,lstmBias:n,lstmForgetBias:r,lstmInitH:i,lstmInitC:o,denseWeights:s,denseBias:t}})})})})})})})}catch(t){return Promise.reject(t)}},t}();const o=function(){function t(){}return t.prototype.then=function(e,n){const r=new t,i=this.s;if(i){const t=1&i?e:n;if(t){try{s(r,1,t(this.v))}catch(t){s(r,2,t)}return r}return this}return this.o=function(t){try{const i=t.v;1&t.s?s(r,1,e?e(i):i):n?s(r,1,n(i)):s(r,2,i)}catch(t){s(r,2,t)}},r},t}();function s(t,e,n){if(!t.s){if(n instanceof o){if(!n.s)return void(n.o=s.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(s.bind(null,t,e),s.bind(null,t,2));t.s=e,t.v=n;const r=t.o;r&&r(t)}}function u(t){return t instanceof o&&1&t.s}function a(t,e,n){for(var r;;){var i=t();if(u(i)&&(i=i.v),!i)return a;if(i.then){r=0;break}var a=n();if(a&&a.then){if(!u(a)){r=1;break}a=a.s}if(e){var c=e();if(c&&c.then&&!u(c)){r=2;break}}}var l=new o,h=s.bind(null,l,2);return(0===r?i.then(d):1===r?a.then(f):c.then(v)).then(void 0,h),l;function f(r){a=r;do{if(e&&(c=e())&&c.then&&!u(c))return void c.then(v).then(void 0,h);if(!(i=t())||u(i)&&!i.v)return void s(l,1,a);if(i.then)return void i.then(d).then(void 0,h);u(a=n())&&(a=a.v)}while(!a||!a.then);a.then(f).then(void 0,h)}function d(t){t?(a=n())&&a.then?a.then(f).then(void 0,h):f(a):s(l,1,a)}function v(){(i=t())?i.then?i.then(d).then(void 0,h):d(i):s(l,1,a)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var c=function(){function t(t){var n=t.actions,r=t.featurizers,i=t.hiddenSize,o=void 0===i?32:i,s=t.optimizer,u=void 0===s?e.train.adam(.01):s,a=t.dropout,c=void 0===a?0:a;this.actions=n,this.featurizers=r,this.optimizer=u,this.hiddenSize=o,this.outputSize=n.length,this.lstmDropout=c}var n=t.prototype;return n.init=function(){try{var t=this;return Promise.resolve(Promise.all(t.featurizers.map(function(e){return e.init(t.actions)}))).then(function(){t.inputSize=t.featurizers.map(function(t){return t.size}).reduce(function(t,e){return t+e},1),t.lstm=new i(t.inputSize,t.hiddenSize,t.outputSize,t.lstmDropout),t.resetDialog()})}catch(t){return Promise.reject(t)}},n.resetDialog=function(){this.featurizers.forEach(function(t){return t.resetDialog()});var t=this.lstm.initLSTM();this.lstmC=t.c,this.lstmH=t.h},n.handleQuery=function(t){try{return Promise.all(this.featurizers.map(function(e){return e.handleQuery(t)}))}catch(t){return Promise.reject(t)}},n.getOptimizableFeatures=function(t){var n=this;return e.tidy(function(){var r=n.featurizers.map(function(e,n){return e.getOptimizableFeatures(t[n])});return r.push(e.zeros([1])),e.concat(r)})},n.handleAction=function(t){this.featurizers.map(function(e){return e.handleAction(t)})},n.getActionMask=function(){var t=this;return e.tidy(function(){return t.featurizers.map(function(t){return e.tensor(t.getActionMask(),void 0,"float32")}).reduce(function(t,n){return e.mul(t,n)},e.ones([t.actions.length]))})},n.fitStory=function(t){try{var n=function(){var t;return r.optimizer.minimize(function(){var n=r.lstm.initLSTM(!1),u=n.c,a=n.h,c=i.map(function(t,e){var n=r.lstm.predict(r.getOptimizableFeatures(t),u,a,o[e]);return u=n.nc,a=n.nh,n.y}),l=e.stack(s),h=e.stack(c),f=e.metrics.categoricalCrossentropy(l,h).mean();return t={targets:e.keep(l.argMax(1)),predictions:e.keep(h.argMax(1)),loss:f.arraySync(),isFailing:e.metrics.categoricalAccuracy(l,h).mean().arraySync()<.999},f}),e.dispose([i,s]),t},r=this;r.resetDialog();var i=[],o=[],s=[],u=0,c=a(function(){return u<t.length},function(){return!!(u+=1)},function(){var n=t[u],a=i.push;return Promise.resolve(r.handleQuery(n.query)).then(function(t){a.call(i,t),o.push(r.getActionMask()),s.push(e.oneHot(r.actions.indexOf(n.action),r.outputSize)),r.handleAction(n.action)})});return Promise.resolve(c&&c.then?c.then(n):n())}catch(t){return Promise.reject(t)}},n.train=function(t){var n=t.stories,r=t.nEpochs,i=void 0===r?12:r,o=t.onEpochEnd,s=void 0===o?void 0:o;try{var u,c=function(){return l.resetDialog(),u},l=this,h=0,f=a(function(){return h<i},function(){return!!(h+=1)},function(){function t(){var t=e.tidy(function(){return e.math.confusionMatrix(e.concat(r),e.concat(i),l.outputSize)}),n=e.tidy(function(){return t.mul(e.eye.apply(e,t.shape)).sum(0)});u={epoch:h,failingSamples:c,accuracy:e.tidy(function(){return n.sum().div(t.sum()).arraySync()}),recall:e.tidy(function(){return n.div(t.sum(1)).mean().arraySync()}),precision:e.tidy(function(){return n.div(t.sum(0)).mean().arraySync()}),loss:o.reduce(function(t,e){return t+e})/o.length},e.dispose(r),e.dispose(i),e.dispose([n,t]),void 0!==s&&s(u)}var r=[],i=[],o=[],c=[],f=0,d=a(function(){return f<n.length},function(){return!!(f+=1)},function(){return Promise.resolve(l.fitStory(n[f])).then(function(t){r.push(t.targets),i.push(t.predictions),o.push(t.loss),t.isFailing&&c.push(f)})});return d&&d.then?d.then(t):t()});return Promise.resolve(f&&f.then?f.then(c):c())}catch(t){return Promise.reject(t)}},n.predict=function(t,n){void 0===n&&(n=1);try{var r=this;r.lstm.dropout=0;var i=r.getOptimizableFeatures;return Promise.resolve(r.handleQuery(t)).then(function(t){var o=i.call(r,t),s=r.getActionMask(),u=r.lstm.predict(o,r.lstmC,r.lstmH,s,n);e.dispose([r.lstmC,r.lstmH]),r.lstmC=u.nc.clone(),r.lstmH=u.nh.clone();var a=e.tidy(function(){return u.y.argMax().arraySync()}),c=e.tidy(function(){return u.y.arraySync()[a]});return e.dispose([o,s]),e.dispose(u),r.lstm.dropout=r.lstmDropout,r.handleAction(r.actions[a]),{action:r.actions[a],confidence:c}})}catch(t){return Promise.reject(t)}},n.score=function(t,n){void 0===n&&(n=1);try{var r=function(){var t=e.tidy(function(){return e.math.confusionMatrix(e.tensor(o),e.tensor(s),i.outputSize)}),n=e.tidy(function(){return t.mul(e.eye.apply(e,t.shape)).sum(0)}),r={failingSamples:c,accuracy:e.tidy(function(){return n.sum().div(t.sum()).arraySync()}),recall:e.tidy(function(){return n.div(t.sum(1)).mean().arraySync()}),precision:e.tidy(function(){return n.div(t.sum(0)).mean().arraySync()}),averageConfidence:u.reduce(function(t,e){return t+e})/u.length};return e.dispose([n,t]),i.resetDialog(),r},i=this,o=[],s=[],u=[],c=[],l=0,h=a(function(){return l<t.length},function(){return!!(l+=1)},function(){i.resetDialog();var e=0,r=a(function(){return e<t[l].length},function(){return!!(e+=1)},function(){var r=t[l][e];return Promise.resolve(i.predict(r.query,n)).then(function(t){var e=t.action,n=t.confidence;o.push(i.actions.indexOf(r.action)),s.push(i.actions.indexOf(e)),u.push(n),e===r.action||c.includes(l)||c.push(l)})});if(r&&r.then)return r.then(function(){})});return Promise.resolve(h&&h.then?h.then(r):r())}catch(t){return Promise.reject(t)}},n.load=function(t){var e=JSON.parse(t);this.featurizers.forEach(function(t){t.load(e[t.id])}),this.lstm.load(e.lstm),this.resetDialog()},n.export=function(){try{var t=this;return Promise.resolve(t.lstm.export()).then(function(e){function n(){return JSON.stringify(r)}var r={lstm:e},i=0,o=a(function(){return i<t.featurizers.length},function(){return!!(i+=1)},function(){var e=t.featurizers[i];return Promise.resolve(e.export()).then(function(t){r[e.id]=t})});return o&&o.then?o.then(n):n()})}catch(t){return Promise.reject(t)}},t}();function l(){return(l=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}).apply(this,arguments)}function h(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var f=function(){function t(){}var e=t.prototype;return e.init=function(t){try{return this.actions=t,Promise.resolve()}catch(t){return Promise.reject(t)}},e.getOptimizableFeatures=function(t){return t},e.handleAction=function(t){},e.getActionMask=function(){return this.actions.map(function(){return!0})},e.resetDialog=function(){},e.load=function(t){},e.export=function(){return Promise.resolve({})},t}(),d=function(t){function r(){var e;return(e=t.apply(this,arguments)||this).id="Universal Sentence Encoder",e.size=512,e}h(r,t);var i=r.prototype;return i.init=function(e){try{var r=this;return Promise.resolve(t.prototype.init.call(r,e)).then(function(){return Promise.resolve(n.load()).then(function(t){return r.encoder=t,Promise.resolve(r.encodeQuery("")).then(function(t){r.emptyEncoding=t})})})}catch(t){return Promise.reject(t)}},i.encodeQuery=function(t){try{return Promise.resolve(this.encoder.embed([t])).then(function(t){var n=t.squeeze();return e.dispose(t),n})}catch(t){return Promise.reject(t)}},i.handleQuery=function(t){try{return Promise.resolve(t?this.encodeQuery(t):this.emptyEncoding.clone())}catch(t){return Promise.reject(t)}},r}(f);function v(t){for(var e=0,n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}var m=function(t){function n(e){var n;return(n=t.call(this)||this).id="Bag-of-Words",n.size=e,n}return h(n,t),n.prototype.handleQuery=function(t){try{var n=this;return Promise.resolve(e.tidy(function(){var r=t.toLowerCase().split(/\W/g).map(function(t){return v(t)%n.size});return e.oneHot(r,n.size).asType("float32").sum(0)}))}catch(t){return Promise.reject(t)}},n}(f);function p(t,e){for(var n=Array.from(Array(t.length+1),function(){return new Array(e.length+1).fill(0)}),r=1;r<=t.length;r+=1)n[r][0]=r;for(var i=1;i<=e.length;i+=1)n[0][i]=i;for(var o=0;o<e.length;o+=1)for(var s=0;s<t.length;s+=1)n[s+1][o+1]=Math.min(n[s][o+1]+1,n[s+1][o]+1,n[s][o]+(t[s]!==e[o]?1:0));return n[t.length][e.length]/Math.max(t.length,e.length,1)}var y=function(t){function n(e,n){var r;return(r=t.call(this)||this).id="Word Embedding",r.size=2*n,r.loaderFunction=e,r}h(n,t);var r=n.prototype;return r.init=function(e){try{var n=this;return Promise.resolve(t.prototype.init.call(n,e)).then(function(){return Promise.resolve(n.loaderFunction()).then(function(t){n.vectors=JSON.parse(t)})})}catch(t){return Promise.reject(t)}},r.handleQuery=function(t){try{var n=this;return Promise.resolve(e.tidy(function(){var r=t.toLowerCase().split(/\W/g).filter(function(t){return t.length>0}),i=[];if(r.forEach(function(t){if(Object.keys(n.vectors).includes(t))i.push(e.tensor(n.vectors[t]));else{var r,o=Infinity;Object.keys(n.vectors).forEach(function(e){var n=p(e,t);n<o&&(r=e,o=n)}),o<.5&&i.push(e.tensor(n.vectors[r]))}}),0===i.length)return e.zeros([n.size]);var o=e.stack(i);return e.concat([o.mean(0),o.max(0)])}))}catch(t){return Promise.reject(t)}},n}(f);function g(t,e){for(var n={extract:void 0,score:0},r=0;r<t.length;r+=1){var i=t.substring(r,r+e.length),o={extract:i,score:1-p(i,e)};if(1===o.score)return o;o.score>n.score&&(n=o)}return n}var z=function(t){function n(e,n,r,i){var o;return void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===i&&(i=.75),(o=t.call(this)||this).categoryNames=Object.keys(e),o.categories=e,o.id="Categorical Slot ("+v(JSON.stringify(o.categoryNames))+")",o.dependantActions=n,o.inverselyDependantActions=r,o.threshold=i,o.size=2*o.categoryNames.length,o}h(n,t);var r=n.prototype;return r.init=function(e){try{var n=this;return Promise.resolve(t.prototype.init.call(n,e)).then(function(){n.resetDialog()})}catch(t){return Promise.reject(t)}},r.featurizeValue=function(t){var n=Object.keys(this.categories);return e.oneHot(n.indexOf(t.category),n.length)},r.handleQuery=function(t){try{var n=this,r={category:void 0,extract:void 0,score:0};Object.entries(n.categories).forEach(function(e){var i=e[0],o=e[1].map(function(e){return g(t.toLowerCase(),e.toLowerCase())}).filter(function(t){return t.score>=n.threshold}).reduce(function(t,e){return t.score>e.score?t:e},{extract:void 0,score:0});o.score>r.score&&(r=l({category:i},o))});var i=e.tidy(function(){return e.concat([n.featurizeValue(r),n.featurizeValue(n.value)])});return void 0!==r.category&&(n.value=r),Promise.resolve(i)}catch(t){return Promise.reject(t)}},r.getActionMask=function(){var t=this;return this.actions.map(function(e){var n=void 0===t.value.extract,r=t.dependantActions.includes(e),i=t.inverselyDependantActions.includes(e);return n&&(i||!r)||!n&&!i})},r.resetDialog=function(){this.value={category:void 0,extract:void 0,score:0}},r.getValue=function(){return this.value},n}(f);t.ActionFeaturizer=function(t){function n(e,n,r){var i;return void 0===e&&(e=!0),void 0===n&&(n=!0),void 0===r&&(r="LUS"),(i=t.call(this)||this).id="Action Featurizer",i.maskLUS=e,i.maskPreviousAction=n,i.LUSAction=r,i.resetDialog(),i}h(n,t);var i=n.prototype;return i.init=function(e){try{var n=this;return Promise.resolve(t.prototype.init.call(n,e)).then(function(){n.size=e.length,n.embeddings=r([n.size,n.size])})}catch(t){return Promise.reject(t)}},i.handleQuery=function(t){try{var n=this;return Promise.resolve(e.tidy(function(){return n.userTalked=""!==t,e.oneHot([n.actions.indexOf(n.previousAction)],n.actions.length)}))}catch(t){return Promise.reject(t)}},i.getOptimizableFeatures=function(t){return t.matMul(this.embeddings).squeeze()},i.handleAction=function(t){this.previousAction=t!==this.LUSAction?t:this.previousAction},i.getActionMask=function(){var e=t.prototype.getActionMask.call(this);return this.maskLUS&&this.userTalked&&(e[this.actions.indexOf(this.LUSAction)]=!1),this.maskPreviousAction&&this.actions.includes(this.previousAction)&&(e[this.actions.indexOf(this.previousAction)]=!1),e},i.resetDialog=function(){this.userTalked=!1,this.previousAction=void 0},i.load=function(t){this.embeddings=e.tidy(function(){return e.tensor(t.embeddings).variable()})},i.export=function(){try{return Promise.resolve(this.embeddings.array()).then(function(t){return{embeddings:t}})}catch(t){return Promise.reject(t)}},n}(f),t.BOW=m,t.CategoricalSlot=z,t.Featurizer=f,t.HCN=c,t.LSTM=i,t.USE=d,t.WordEmbedding=y,t.fuzzyMatch=g,t.hashcode=v,t.initializeVariable=r,t.parseStories=function(t){var e=[],n=[],r=!0;return t.split("\n").forEach(function(t){var i=/^## *([^#].*)?$/gm.exec(t),o=/^> *(.*)$/gm.exec(t),s=/^- *(\w*)$/gm.exec(t);null!=i&&n.length>0?(n.push({query:"",action:"LUS"}),e.push(n),n=[]):null!=o?(n.length>0&&n.push({query:"",action:"LUS"}),n.push({query:o[1],action:void 0}),r=!1):null!=s&&r?n.push({query:"",action:s[1]}):null==s||r||(n[n.length-1].action=s[1],r=!0)}),n.length>0&&(n.push({query:"",action:"LUS"}),e.push(n)),e},t.trainTestSplit=function(t,e){for(var n=[],r=0;r/t.length<e;r+=1)n.push.apply(n,t.splice(Math.floor(Math.random()*t.length),1));return{train:t,test:n}}});
//# sourceMappingURL=wisty.umd.js.map
