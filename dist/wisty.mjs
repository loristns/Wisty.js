import{load as t}from"@tensorflow-models/universal-sentence-encoder";import{train as e,tidy as n,randomNormal as r,basicLSTMCell as i,stack as o,dropout as s,losses as a,metrics as u,zeros as c,concat as h,dispose as l,oneHot as f,moments as m,tensor as v}from"@tensorflow/tfjs";var d=function t(n,r,i,o,s){void 0===o&&(o=e.adam()),void 0===s&&(s=.2),this.lstmKernel=t.randomVariable([n+r,4*r]),this.lstmBias=t.randomVariable([4*r]),this.lstmForgetBias=t.randomVariable([1],!0),this.lstmInitH=t.randomVariable([1,r]),this.lstmInitC=t.randomVariable([1,r]),this.denseWeights=t.randomVariable([r,i]),this.denseBias=t.randomVariable([i]),this.optimizer=o,this.dropout=s};d.randomVariable=function(t,e){return void 0===e&&(e=!1),n(function(){var n=r(t);return e&&(n=n.asScalar()),n.variable()})},d.prototype.initLSTM=function(){return{c:this.lstmInitC.clone(),h:this.lstmInitH.clone()}},d.prototype.predict=function(t,e,r){var a=this;return n(function(){var n=i(a.lstmForgetBias,a.lstmKernel,a.lstmBias,o([t]),r,e),u=n[0],c=n[1];return{y:s(c,a.dropout).matMul(a.denseWeights).add(a.denseBias).squeeze(),nc:u,nh:c}})},d.prototype.fitSequence=function(t,e){var n,r,i=this;return this.optimizer.minimize(function(){var s=i.lstmInitC,c=i.lstmInitH,h=o(t.unstack().map(function(t){var e=i.predict(t,s,c);return s=e.nc,c=e.nh,e.y})),l=a.softmaxCrossEntropy(e,h);return n=l.arraySync(),r=u.categoricalAccuracy(e,h).mean().arraySync(),l}),{loss:n,accuracy:r}},d.prototype.setWeights=function(t){var e=this;Object.entries(t).forEach(function(t){var n=t[1];switch(t[0]){case"lstmKernel":e.lstmKernel=n;break;case"lstmBias":e.lstmBias=n;break;case"lstmForgetBias":e.lstmForgetBias=n;break;case"lstmInitH":e.lstmInitH=n;break;case"lstmInitC":e.lstmInitC=n;break;case"denseWeights":e.denseWeights=n;break;case"denseBias":e.denseBias=n}})},d.prototype.getWeights=function(){return{lstmKernel:this.lstmKernel.clone(),lstmBias:this.lstmBias.clone(),lstmForgetBias:this.lstmForgetBias.clone(),lstmInitH:this.lstmInitH.clone(),lstmInitC:this.lstmInitC.clone(),denseWeights:this.denseWeights.clone(),denseBias:this.denseBias.clone()}};const p=function(){function t(){}return t.prototype.then=function(e,n){const r=new t,i=this.s;if(i){const t=1&i?e:n;if(t){try{y(r,1,t(this.v))}catch(t){y(r,2,t)}return r}return this}return this.o=function(t){try{const i=t.v;1&t.s?y(r,1,e?e(i):i):n?y(r,1,n(i)):y(r,2,i)}catch(t){y(r,2,t)}},r},t}();function y(t,e,n){if(!t.s){if(n instanceof p){if(!n.s)return void(n.o=y.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(y.bind(null,t,e),y.bind(null,t,2));t.s=e,t.v=n;const r=t.o;r&&r(t)}}function b(t){return t instanceof p&&1&t.s}function g(t,e,n){for(var r;;){var i=t();if(b(i)&&(i=i.v),!i)return o;if(i.then){r=0;break}var o=n();if(o&&o.then){if(!b(o)){r=1;break}o=o.s}if(e){var s=e();if(s&&s.then&&!b(s)){r=2;break}}}var a=new p,u=y.bind(null,a,2);return(0===r?i.then(h):1===r?o.then(c):s.then(l)).then(void 0,u),a;function c(r){o=r;do{if(e&&(s=e())&&s.then&&!b(s))return void s.then(l).then(void 0,u);if(!(i=t())||b(i)&&!i.v)return void y(a,1,o);if(i.then)return void i.then(h).then(void 0,u);b(o=n())&&(o=o.v)}while(!o||!o.then);o.then(c).then(void 0,u)}function h(t){t?(o=n())&&o.then?o.then(c).then(void 0,u):c(o):y(a,1,o)}function l(){(i=t())?i.then?i.then(h).then(void 0,u):h(i):y(a,1,o)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var S=function(t,n,r,i,o){void 0===r&&(r=128),void 0===i&&(i=e.adam(.01)),void 0===o&&(o=.2),this.actions=t,this.featurizers=n,this.inputSize=n.map(function(t){return t.size}).reduce(function(t,e){return t+e},1),this.outputSize=t.length,this.lstm=new d(this.inputSize,r,this.outputSize,i,o),this.lstmDropout=o,this.resetDialog()};S.prototype.resetDialog=function(){var t;this.featurizers.forEach(function(t){return t.resetDialog()}),t=this.lstm.initLSTM(),this.lstmC=t.c,this.lstmH=t.h},S.prototype.featurize=function(t){try{return Promise.resolve(Promise.all(this.featurizers.map(function(e){return e.handleQuery(t)}))).then(function(t){t.push(c([1]));var e=h(t);return l(t),e})}catch(t){return Promise.reject(t)}},S.prototype.fitStory=function(t,e){try{var r=this;function i(){var t=Object.assign({},{epoch:e},n(function(){return r.lstm.fitSequence(o(s),o(a))}));return l([s,a]),t}r.resetDialog();var s=[],a=[],u=0,c=g(function(){return u<t.length},function(){return!!(u+=1)},function(){var e=t[u],n=s.push;return Promise.resolve(r.featurize(e.query)).then(function(t){n.call(s,t),a.push(f(r.actions.indexOf(e.action),r.outputSize))})});return Promise.resolve(c&&c.then?c.then(i):i())}catch(t){return Promise.reject(t)}},S.prototype.train=function(t,e,n){void 0===e&&(e=12);try{var r=this;function i(){return r.resetDialog(),o}var o=[],s=0,a=g(function(){return s<e},function(){return!!(s+=1)},function(){var e=[];return t.forEach(function(t){e.push(r.fitStory(t,s))}),Promise.resolve(Promise.all(e)).then(function(t){e=t,void 0!==n&&n(e),o.push.apply(o,e)})});return Promise.resolve(a&&a.then?a.then(i):i())}catch(t){return Promise.reject(t)}},S.prototype.predict=function(t,e,r){void 0===e&&(e=10),void 0===r&&(r=1);try{var i=this;return 1===e&&(i.lstm.dropout=0),Promise.resolve(i.featurize(t)).then(function(t){for(var s,a=[],u=0;u<e;u+=1)l(s),s=i.lstm.predict(t,i.lstmC,i.lstmH),a.push(n(function(){return s.y.div(r).softmax()}));l([i.lstmC,i.lstmH]),i.lstmC=s.nc.clone(),i.lstmH=s.nh.clone();var c=n(function(){return m(o(a),0)}),h=c.mean,f=c.variance,v=n(function(){return h.argMax().arraySync()}),d=1-n(function(){return f.sqrt().arraySync()[v]});return l([t,h,f]),l(s),l(a),{action:i.actions[v],confidence:d}})}catch(t){return Promise.reject(t)}},S.prototype.load=function(t){var e=this;n(function(){var n=JSON.parse(t);Object.entries(n).forEach(function(t){n[t[0]]=v(t[1]).variable()}),e.lstm.setWeights(n)})},S.prototype.export=function(){var t=this;return n(function(){var e={};return Object.entries(t.lstm.getWeights()).forEach(function(t){e[t[0]]=t[1].arraySync()}),JSON.stringify(e)})};var P=function(){this.size=512};P.prototype.init=function(){try{var e=this;return Promise.resolve(t()).then(function(t){return e.encoder=t,Promise.resolve(e.encodeQuery("")).then(function(t){e.emptyEncoding=t})})}catch(t){return Promise.reject(t)}},P.prototype.encodeQuery=function(t){try{return Promise.resolve(this.encoder.embed([t])).then(function(t){var e=t.squeeze();return l(t),e})}catch(t){return Promise.reject(t)}},P.prototype.handleQuery=function(t){try{return t?Promise.resolve(this.encodeQuery(t)):Promise.resolve(this.emptyEncoding.clone())}catch(t){return Promise.reject(t)}},P.prototype.resetDialog=function(){};var z=function(t){this.size=t};z.prototype.handleQuery=function(t){try{var e=this;return Promise.resolve(n(function(){var n=t.split(" ").map(function(t){return function(t){for(var e=0,n=0;n<t.length;n+=1)e=(e<<5)-e+t.charCodeAt(n),e|=0;return e}(t)%e.size});return f(n,e.size).asType("float32").sum(0)}))}catch(t){return Promise.reject(t)}},z.prototype.resetDialog=function(){};var B=function(t){try{return Promise.resolve(fetch(t).then(function(t){return t.text()})).then(function(t){var e={query:void 0,action:void 0},n=[],r=[];return t.split("\n").forEach(function(t){var i=t.substring(2);t.startsWith("## ")?(n.length>0&&(void 0!==e.action&&(n.push(e),e={query:void 0,action:void 0}),r.push(n)),n=[]):t.startsWith("- ")?void 0===e.action?e.action=i:(n.push(e),e={query:"",action:i}):t.startsWith("> ")&&(void 0===e.query?e.query=i:void 0!==e.action?(n.push(e),n.push({query:"",action:"LUS"}),e={query:i,action:void 0}):e.query+=" "+i)}),void 0!==e.action&&n.push(e),n.push({query:"",action:"LUS"}),n&&r.push(n),r})}catch(t){return Promise.reject(t)}};export{d as LSTM,S as HCN,P as USE,z as BOW,B as loadStories};
//# sourceMappingURL=wisty.mjs.map
